# Collide é¡¹ç›® Docker éƒ¨ç½²æŒ‡å—

## ğŸ“‹ éƒ¨ç½²æ¶æ„

æœ¬é¡¹ç›®é‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼ŒåŒ…å«ä¸­é—´ä»¶å’Œä¸šåŠ¡æœåŠ¡ä¸¤ä¸ªéƒ¨åˆ†ï¼Œæ‰€æœ‰æœåŠ¡éƒ½è¿è¡Œåœ¨åŒä¸€ä¸ªè‡ªå®šä¹‰Dockerç½‘ç»œä¸­ï¼Œä½¿ç”¨å›ºå®šIPåœ°å€è¿›è¡Œé€šä¿¡ã€‚

### ğŸŒ ç½‘ç»œé…ç½®

- **ç½‘ç»œåç§°**: `collide-network`
- **å­ç½‘èŒƒå›´**: `172.20.0.0/16`
- **ç½‘å…³åœ°å€**: `172.20.0.1`

### ğŸ“ IP åœ°å€åˆ†é…

#### ä¸­é—´ä»¶æœåŠ¡ (172.20.1.x)
| æœåŠ¡ | å®¹å™¨å | IPåœ°å€ | ç«¯å£æ˜ å°„ | ç”¨é€” |
|------|--------|--------|----------|------|
| MySQL | mysql | 172.20.1.10 | 3306:3306 | æ•°æ®åº“ |
| MinIO | minio | 172.20.1.20 | 9000:9000, 9001:9001 | å¯¹è±¡å­˜å‚¨ |
| Nacos | nacos | 172.20.1.30 | 8848:8848, 9848:9848 | æœåŠ¡æ³¨å†Œ/é…ç½®ä¸­å¿ƒ |
| Redis | redis | 172.20.1.40 | 6379:6379 | ç¼“å­˜æ•°æ®åº“ |
| Seata | seata-server | 172.20.1.50 | 7091:7091, 8091:8091 | åˆ†å¸ƒå¼äº‹åŠ¡ |
| Sentinel | sentinel-dashboard | 172.20.1.60 | 8888:8888 | æµé‡æ§åˆ¶ |
| RocketMQ NameServer | rocketmq-nameserver | 172.20.1.70 | 9876:9876 | æ¶ˆæ¯é˜Ÿåˆ—å‘½åæœåŠ¡ |
| RocketMQ Broker | rocketmq-broker | 172.20.1.71 | 10909:10909, 10911:10911 | æ¶ˆæ¯é˜Ÿåˆ—ä»£ç† |
| Elasticsearch | elasticsearch | 172.20.1.80 | 9200:9200, 9300:9300 | æœç´¢å¼•æ“ |

#### ä¸šåŠ¡æœåŠ¡ (172.20.2.x)
| æœåŠ¡ | å®¹å™¨å | IPåœ°å€ | ç«¯å£æ˜ å°„ | ç”¨é€” |
|------|--------|--------|----------|------|
| Gateway | collide-gateway | 172.20.2.10 | 9501:9501 | APIç½‘å…³ |
| Auth | collide-auth | 172.20.2.20 | 9502:9502 | è®¤è¯æœåŠ¡ |
| Application | collide-application | 172.20.2.30 | 9503:9503 | ä¸šåŠ¡èšåˆæœåŠ¡ |

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. ç¯å¢ƒå‡†å¤‡

ç¡®ä¿æ‚¨çš„ç³»ç»Ÿå·²å®‰è£…ï¼š
- Docker (20.10+)
- Docker Compose (2.0+)

### 2. åˆ›å»ºç½‘ç»œå¹¶åˆå§‹åŒ–æ•°æ®åº“

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹è¿è¡Œç½‘ç»œåˆå§‹åŒ–è„šæœ¬ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- åˆ›å»ºDockerè‡ªå®šä¹‰ç½‘ç»œ
- æ£€æµ‹MySQLå®¹å™¨çŠ¶æ€
- è‡ªåŠ¨åˆ›å»ºcollideç›¸å…³æ•°æ®åº“
- æŒ‰é¡ºåºå¯¼å…¥æ‰€æœ‰SQLæ–‡ä»¶

**Linux/macOS:**
```bash
# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x scripts/init-network.sh

# è¿è¡Œè„šæœ¬ï¼ˆä¼šè¯¢é—®æ˜¯å¦åˆå§‹åŒ–æ•°æ®åº“ï¼‰
./scripts/init-network.sh
```

**Windows:**
```cmd
# è¿è¡Œæ‰¹å¤„ç†è„šæœ¬ï¼ˆä¼šè¯¢é—®æ˜¯å¦åˆå§‹åŒ–æ•°æ®åº“ï¼‰
scripts\init-network.bat
```

**æ•°æ®åº“åˆå§‹åŒ–åŠŸèƒ½åŒ…æ‹¬ï¼š**
- è‡ªåŠ¨åˆ›å»ºæ•°æ®åº“ï¼š`collide_auth`ã€`collide_business`ã€`nacos_mysql`
- æŒ‰é¡ºåºå¯¼å…¥SQLæ–‡ä»¶ï¼š
  1. `01-init-database.sql` - åˆå§‹åŒ–æ•°æ®åº“ç»“æ„
  2. `nacos-mysql.sql` - Nacosé…ç½®ä¸­å¿ƒè¡¨
  3. `02-auth-tables.sql` - è®¤è¯ç›¸å…³è¡¨
  4. `02-user-profile-table.sql` - ç”¨æˆ·é…ç½®è¡¨
  5. `collide-business.sql` - ä¸šåŠ¡æ ¸å¿ƒè¡¨
  6. `03-fix-status-field.sql` - çŠ¶æ€å­—æ®µä¿®å¤
  7. `04-performance-optimization.sql` - æ€§èƒ½ä¼˜åŒ–è„šæœ¬
  8. `06-search-tables.sql` - æœç´¢åŠŸèƒ½è¡¨
  9. `07-category-tag-system.sql` - åˆ†ç±»æ ‡ç­¾ç³»ç»Ÿè¡¨

### 3. å¯åŠ¨ä¸­é—´ä»¶æœåŠ¡

```bash
# è¿›å…¥ä¸­é—´ä»¶ç›®å½•
cd middleware

# å¯åŠ¨æ‰€æœ‰ä¸­é—´ä»¶æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps
```

### 4. ç­‰å¾…ä¸­é—´ä»¶åˆå§‹åŒ–

ç­‰å¾…å…³é”®æœåŠ¡å¯åŠ¨å®Œæˆï¼ˆç‰¹åˆ«æ˜¯MySQLå’ŒNacosï¼‰ï¼š

```bash
# æ£€æŸ¥MySQLå¥åº·çŠ¶æ€
docker logs mysql

# æ£€æŸ¥Nacoså¯åŠ¨çŠ¶æ€
docker logs nacos
```

### 5. å¯åŠ¨ä¸šåŠ¡æœåŠ¡

```bash
# è¿”å›é¡¹ç›®æ ¹ç›®å½•
cd ..

# æ„å»ºå¹¶å¯åŠ¨ä¸šåŠ¡æœåŠ¡
docker-compose up -d --build

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps
```

## ğŸ”§ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡é…ç½®

ä¸šåŠ¡æœåŠ¡å·²é¢„é…ç½®æ‰€æœ‰ä¸­é—´ä»¶çš„å›ºå®šIPåœ°å€ï¼š

- **Nacos**: `172.20.1.30:8848`
- **MySQL**: `172.20.1.10:3306`
- **Redis**: `172.20.1.40:6379`
- **RocketMQ**: `172.20.1.70:9876`
- **Elasticsearch**: `172.20.1.80:9200`
- **Seata**: `172.20.1.50:8091`
- **MinIO**: `172.20.1.20:9000`

### æ•°æ®åº“è‡ªåŠ¨åˆå§‹åŒ–

å¦‚æœåœ¨æ­¥éª¤2ä¸­é€‰æ‹©äº†æ•°æ®åº“åˆå§‹åŒ–ï¼Œæ‰€æœ‰æ•°æ®åº“å’Œè¡¨å·²è‡ªåŠ¨åˆ›å»ºã€‚å¦‚æœè·³è¿‡äº†åˆå§‹åŒ–ï¼Œå¯ä»¥æ‰‹åŠ¨è¿è¡Œï¼š

```bash
# æ‰‹åŠ¨è¿è¡Œæ•°æ®åº“åˆå§‹åŒ–ï¼ˆç¡®ä¿MySQLå®¹å™¨å·²å¯åŠ¨ï¼‰
./scripts/init-network.sh  # Linux/macOS
# æˆ–
scripts\init-network.bat   # Windows
```

## ğŸ“Š æœåŠ¡ç›‘æ§

### è®¿é—®åœ°å€

- **Nacosæ§åˆ¶å°**: http://localhost:8848/nacos (nacos/nacos)
- **Sentinelæ§åˆ¶å°**: http://localhost:8888 (sentinel/sentinel)
- **MinIOæ§åˆ¶å°**: http://localhost:9001 (minioadmin/minioadmin)
- **Elasticsearch**: http://localhost:9200
- **Redis**: localhost:6379 (å¯†ç : 123456)

### å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥ç½‘ç»œè¿æ¥
docker network inspect collide-network

# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨çŠ¶æ€
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker logs <container_name>
```

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ç½‘ç»œè¿æ¥é—®é¢˜**
   ```bash
   # é‡æ–°åˆ›å»ºç½‘ç»œ
   docker network rm collide-network
   ./scripts/init-network.sh
   ```

2. **ç«¯å£å†²çª**
   ```bash
   # æ£€æŸ¥ç«¯å£å ç”¨
   netstat -tlnp | grep <port>
   ```

3. **æœåŠ¡å¯åŠ¨å¤±è´¥**
   ```bash
   # æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
   docker-compose logs <service_name>
   
   # é‡å¯æœåŠ¡
   docker-compose restart <service_name>
   ```

### æ¸…ç†å’Œé‡ç½®

```bash
# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose down
cd middleware && docker-compose down

# åˆ é™¤æ‰€æœ‰å®¹å™¨å’Œé•œåƒï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
docker system prune -af

# åˆ é™¤æ•°æ®å·ï¼ˆä¼šä¸¢å¤±æ•°æ®ï¼‰
docker volume prune -f
```

## ğŸ” å®‰å…¨æ³¨æ„äº‹é¡¹

1. **ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²**ï¼š
   - ä¿®æ”¹æ‰€æœ‰é»˜è®¤å¯†ç 
   - ä½¿ç”¨ç¯å¢ƒå˜é‡æ–‡ä»¶ç®¡ç†æ•æ„Ÿä¿¡æ¯
   - é…ç½®é˜²ç«å¢™è§„åˆ™é™åˆ¶å¤–éƒ¨è®¿é—®

2. **ç½‘ç»œå®‰å…¨**ï¼š
   - ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨æ›´å¤æ‚çš„ç½‘ç»œé…ç½®
   - è€ƒè™‘ä½¿ç”¨Docker Swarmæˆ–Kubernetesè¿›è¡Œç¼–æ’

3. **æ•°æ®å¤‡ä»½**ï¼š
   - å®šæœŸå¤‡ä»½MySQLæ•°æ®
   - å¤‡ä»½Nacosé…ç½®
   - å¤‡ä»½MinIOå­˜å‚¨æ•°æ®

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœåœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æ£€æŸ¥Dockerå’ŒDocker Composeç‰ˆæœ¬
2. ç¡®è®¤ç½‘ç»œé…ç½®æ­£ç¡®
3. æŸ¥çœ‹ç›¸å…³æœåŠ¡æ—¥å¿—
4. å‚è€ƒé¡¹ç›®æ–‡æ¡£æˆ–è”ç³»æŠ€æœ¯æ”¯æŒ

---

**æ³¨æ„**: æ­¤é…ç½®é€‚ç”¨äºå¼€å‘å’Œæµ‹è¯•ç¯å¢ƒã€‚ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è¯·æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´é…ç½®ã€‚ 