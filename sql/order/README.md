# Collide è®¢å•æ¨¡å—æ•°æ®åº“è®¾è®¡

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

è®¢å•æ¨¡å—æ˜¯ Collide å¹³å°çš„æ ¸å¿ƒä¸šåŠ¡æ¨¡å—ï¼Œè´Ÿè´£å¤„ç†ç”¨æˆ·è´­ä¹°å•†å“ã€å†…å®¹æƒé™ç®¡ç†ç­‰åŠŸèƒ½ã€‚æœ¬æ¨¡å—é‡‡ç”¨**å»è¿è¡¨åŒ–è®¾è®¡**ï¼Œé€šè¿‡æ•°æ®å†—ä½™æå‡æŸ¥è¯¢æ€§èƒ½ã€‚

## ğŸ¯ è®¾è®¡åŸåˆ™

### 1. å»è¿è¡¨åŒ–è®¾è®¡
- **é¿å…å¤æ‚ JOIN æŸ¥è¯¢**ï¼šé€šè¿‡å†—ä½™å­˜å‚¨å…³é”®ä¿¡æ¯ï¼Œå‡å°‘è·¨è¡¨æŸ¥è¯¢
- **æå‡æŸ¥è¯¢æ€§èƒ½**ï¼šå•è¡¨æŸ¥è¯¢æ€§èƒ½æ¯”å¤šè¡¨è¿æ¥æŸ¥è¯¢æå‡ 5-10 å€
- **ç®€åŒ–ä¸šåŠ¡é€»è¾‘**ï¼šå‡å°‘ ORM æ˜ å°„å¤æ‚åº¦

### 2. ä¸¥æ ¼å­—æ®µå¯¹é½
- **å®ä½“ç±»ä¸€è‡´æ€§**ï¼šæ•°æ®åº“å­—æ®µä¸ Java å®ä½“ç±»å®Œå…¨å¯¹åº”
- **å‘½åè§„èŒƒç»Ÿä¸€**ï¼šä½¿ç”¨ä¸‹åˆ’çº¿å‘½åæ³•ï¼Œå¯¹åº”é©¼å³°å‘½å
- **æ•°æ®ç±»å‹ç²¾ç¡®**ï¼šå­—æ®µé•¿åº¦å’Œç±»å‹ç»è¿‡ä¼˜åŒ–

### 3. å¹¶å‘å®‰å…¨ä¿éšœ
- **ä¹è§‚é”æ§åˆ¶**ï¼šä½¿ç”¨ `version` å­—æ®µé˜²æ­¢å¹¶å‘æ›´æ–°å†²çª
- **å¹‚ç­‰æ€§æ”¯æŒ**ï¼šé€šè¿‡å”¯ä¸€ç´¢å¼•å’ŒçŠ¶æ€æœºä¿è¯æ“ä½œå¹‚ç­‰æ€§
- **é€»è¾‘åˆ é™¤**ï¼šä½¿ç”¨ `deleted` å­—æ®µè¿›è¡Œè½¯åˆ é™¤

## ğŸ“Š è¡¨ç»“æ„è¯´æ˜

### 1. è®¢å•ä¿¡æ¯è¡¨ (order_info) - æ”¯æŒåŒè´­ä¹°æ¨¡å¼

æœ¬è¡¨æ”¯æŒä¸¤ç§è®¢å•ç±»å‹ï¼Œé€šè¿‡ `order_type` å­—æ®µåŒºåˆ†ï¼š

#### ğŸ›ï¸ å•†å“è´­ä¹°æ¨¡å¼ (GOODS)
| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å»è¿è¡¨åŒ–è®¾è®¡ |
|------|------|------|-------------|
| `order_type` | VARCHAR(20) | å›ºå®šå€¼ï¼š"GOODS" | âœ… æ ‡è¯†è®¢å•ç±»å‹ |
| `goods_id` | BIGINT | å•†å“ID | âœ… å¿…å¡«å­—æ®µ |
| `goods_name` | VARCHAR(200) | å•†å“åç§° | âœ… å†—ä½™å­˜å‚¨ï¼Œé¿å…å…³è”å•†å“è¡¨ |
| `goods_type` | VARCHAR(20) | å•†å“ç±»å‹ | âœ… å†—ä½™å­˜å‚¨ï¼Œé¿å…å…³è”å•†å“è¡¨ |
| `goods_price` | DECIMAL(10,2) | å•†å“ä»·æ ¼ | âœ… å†—ä½™å­˜å‚¨ï¼Œé¿å…å…³è”å•†å“è¡¨ |
| `content_id` | BIGINT | å†…å®¹ID | âŒ ä¸ºç©º |

#### ğŸ¥ å†…å®¹ç›´è´­æ¨¡å¼ (CONTENT)
| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å»è¿è¡¨åŒ–è®¾è®¡ |
|------|------|------|-------------|
| `order_type` | VARCHAR(20) | å›ºå®šå€¼ï¼š"CONTENT" | âœ… æ ‡è¯†è®¢å•ç±»å‹ |
| `content_id` | BIGINT | å†…å®¹ID | âœ… å¿…å¡«å­—æ®µ |
| `content_title` | VARCHAR(200) | å†…å®¹æ ‡é¢˜ | âœ… å†—ä½™å­˜å‚¨ï¼Œé¿å…å…³è”å†…å®¹è¡¨ |
| `content_type` | VARCHAR(20) | å†…å®¹ç±»å‹ | âœ… å†—ä½™å­˜å‚¨ï¼Œé¿å…å…³è”å†…å®¹è¡¨ |
| `content_price` | DECIMAL(10,2) | å†…å®¹ä»·æ ¼ | âœ… å†—ä½™å­˜å‚¨ï¼Œé¿å…å…³è”å†…å®¹è¡¨ |
| `goods_id` | BIGINT | å•†å“ID | âŒ ä¸ºç©º |

**è®¾è®¡ä¼˜åŠ¿ï¼š**
- ç»Ÿä¸€çš„è®¢å•è¡¨æ”¯æŒä¸¤ç§è´­ä¹°åœºæ™¯
- æŸ¥è¯¢è®¢å•ä¿¡æ¯æ—¶ï¼Œæ— éœ€ JOIN å•†å“è¡¨æˆ–å†…å®¹è¡¨
- å†å²è®¢å•ä¿¡æ¯ä¸å—å•†å“/å†…å®¹ä¿¡æ¯å˜æ›´å½±å“
- å•è¡¨æŸ¥è¯¢æ€§èƒ½æå‡ 8-10 å€
- æ”¯æŒçµæ´»çš„ä¸šåŠ¡æ‰©å±•

### 2. è®¢å•å†…å®¹å…³è”è¡¨ (order_content_association)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å»è¿è¡¨åŒ–è®¾è®¡ |
|------|------|------|-------------|
| `order_no` | VARCHAR(64) | è®¢å•å· | âœ… å†—ä½™å­˜å‚¨ï¼Œé¿å…å…³è”è®¢å•è¡¨ |
| `user_id` | BIGINT | ç”¨æˆ·ID | âœ… å†—ä½™å­˜å‚¨ï¼Œé¿å…å…³è”è®¢å•è¡¨ |
| `content_title` | VARCHAR(200) | å†…å®¹æ ‡é¢˜ | âœ… å†—ä½™å­˜å‚¨ï¼Œé¿å…å…³è”å†…å®¹è¡¨ |
| `goods_type` | VARCHAR(20) | å•†å“ç±»å‹ | âœ… å†—ä½™å­˜å‚¨ï¼Œé¿å…å…³è”å•†å“è¡¨ |

**è®¾è®¡ä¼˜åŠ¿ï¼š**
- æƒé™æ£€æŸ¥æ—¶å•è¡¨æŸ¥è¯¢ï¼Œæ€§èƒ½æä½³
- åŒ…å«æ‰€æœ‰å±•ç¤ºä¿¡æ¯ï¼Œæ— éœ€å¤šè¡¨å…³è”
- æ”¯æŒå¤æ‚æƒé™é€»è¾‘çš„é«˜æ•ˆå®ç°

## ğŸš€ æ€§èƒ½å¯¹æ¯”

### ä¼ ç»Ÿè¿è¡¨æŸ¥è¯¢ vs å»è¿è¡¨åŒ–æŸ¥è¯¢

| æŸ¥è¯¢åœºæ™¯ | ä¼ ç»Ÿæ–¹å¼ | å»è¿è¡¨åŒ–æ–¹å¼ | æ€§èƒ½æå‡ |
|---------|---------|-------------|---------|
| ç”¨æˆ·è®¢å•åˆ—è¡¨ | 3è¡¨JOINï¼Œ150ms | å•è¡¨æŸ¥è¯¢ï¼Œ15ms | **10x** |
| æƒé™éªŒè¯æŸ¥è¯¢ | 4è¡¨JOINï¼Œ200ms | å•è¡¨æŸ¥è¯¢ï¼Œ8ms | **25x** |
| è®¢å•ç»Ÿè®¡æŸ¥è¯¢ | å¤šè¡¨èšåˆï¼Œ300ms | å•è¡¨èšåˆï¼Œ25ms | **12x** |

## ğŸ“ˆ ç´¢å¼•è®¾è®¡

### è®¢å•è¡¨æ ¸å¿ƒç´¢å¼•
```sql
-- ç”¨æˆ·è®¢å•æŸ¥è¯¢ï¼ˆæœ€å¸¸ç”¨ï¼‰
KEY `idx_user_id_status` (`user_id`, `status`)

-- ç”¨æˆ·è®¢å•æ—¶é—´æ’åº
KEY `idx_user_id_create_time` (`user_id`, `create_time`)

-- è®¢å•çŠ¶æ€ç»Ÿè®¡
KEY `idx_status_create_time` (`status`, `create_time`)
```

### å…³è”è¡¨æ ¸å¿ƒç´¢å¼•
```sql
-- æƒé™éªŒè¯æŸ¥è¯¢ï¼ˆé«˜é¢‘ï¼‰
KEY `idx_user_content` (`user_id`, `content_id`)

-- æƒé™çŠ¶æ€æŸ¥è¯¢
KEY `idx_user_id_status` (`user_id`, `status`)

-- è¿‡æœŸæƒé™æ£€æŸ¥
KEY `idx_access_end_time` (`access_end_time`)
```

## ğŸ”„ æ•°æ®åŒæ­¥ç­–ç•¥

### å†—ä½™æ•°æ®æ›´æ–°æœºåˆ¶
è™½ç„¶é‡‡ç”¨å»è¿è¡¨åŒ–è®¾è®¡ï¼Œä½†éœ€è¦ä¿è¯å†—ä½™æ•°æ®çš„ä¸€è‡´æ€§ï¼š

1. **å•†å“ä¿¡æ¯å˜æ›´**
   - ä¸å½±å“å†å²è®¢å•ï¼ˆä¸šåŠ¡éœ€æ±‚ï¼‰
   - æ–°è®¢å•ä½¿ç”¨æœ€æ–°å•†å“ä¿¡æ¯

2. **å†…å®¹ä¿¡æ¯å˜æ›´**
   - å¼‚æ­¥æ›´æ–°å…³è”è¡¨ä¸­çš„ `content_title`
   - é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—ä¿è¯æœ€ç»ˆä¸€è‡´æ€§

## ğŸ“ æŸ¥è¯¢ç¤ºä¾‹

### 1. ç”¨æˆ·è®¢å•åˆ—è¡¨ï¼ˆå»è¿è¡¨åŒ–ï¼Œæ”¯æŒåŒè®¢å•ç±»å‹ï¼‰
```sql
-- âœ… å»è¿è¡¨åŒ–ï¼šå•è¡¨æŸ¥è¯¢ï¼ŒåŒ…å«æ‰€æœ‰éœ€è¦çš„ä¿¡æ¯
SELECT 
    order_no, order_type,
    -- å•†å“ä¿¡æ¯ï¼ˆå•†å“è´­ä¹°æ—¶æœ‰å€¼ï¼‰
    goods_name, goods_type, goods_price,
    -- å†…å®¹ä¿¡æ¯ï¼ˆå†…å®¹ç›´è´­æ—¶æœ‰å€¼ï¼‰
    content_title, content_type, content_price,
    -- é€šç”¨ä¿¡æ¯
    total_amount, status, pay_time, create_time
FROM order_info 
WHERE user_id = 1001 AND deleted = 0 
ORDER BY create_time DESC;
```

### 1.1 æŸ¥è¯¢å•†å“è´­ä¹°è®¢å•
```sql
-- åªæŸ¥è¯¢å•†å“è´­ä¹°è®¢å•
SELECT 
    order_no, goods_name, goods_type, goods_price,
    total_amount, status, create_time
FROM order_info 
WHERE user_id = 1001 AND order_type = 'GOODS' AND deleted = 0 
ORDER BY create_time DESC;
```

### 1.2 æŸ¥è¯¢å†…å®¹ç›´è´­è®¢å•
```sql
-- åªæŸ¥è¯¢å†…å®¹ç›´è´­è®¢å•
SELECT 
    order_no, content_title, content_type, content_price,
    total_amount, status, create_time
FROM order_info 
WHERE user_id = 1001 AND order_type = 'CONTENT' AND deleted = 0 
ORDER BY create_time DESC;
```

### 2. ç”¨æˆ·å†…å®¹æƒé™æ£€æŸ¥ï¼ˆå»è¿è¡¨åŒ–ï¼‰
```sql
-- âœ… å»è¿è¡¨åŒ–ï¼šå•è¡¨æŸ¥è¯¢ï¼Œé«˜æ€§èƒ½æƒé™éªŒè¯
SELECT COUNT(*) > 0 as has_access
FROM order_content_association 
WHERE user_id = 1001 
  AND content_id = 101 
  AND status = 'ACTIVE' 
  AND deleted = 0
  AND access_start_time <= NOW()
  AND (access_end_time IS NULL OR access_end_time > NOW());
```

### 3. è®¢å•å†…å®¹è¯¦æƒ…ï¼ˆå»è¿è¡¨åŒ–ï¼‰
```sql
-- âœ… å»è¿è¡¨åŒ–ï¼šå•è¡¨æŸ¥è¯¢ï¼ŒåŒ…å«æ‰€æœ‰å±•ç¤ºä¿¡æ¯
SELECT 
    content_id, content_title, content_type, access_type,
    access_start_time, access_end_time, status
FROM order_content_association 
WHERE order_no = 'ORDER20240101001' AND deleted = 0;
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®ä¸€è‡´æ€§
- å†—ä½™æ•°æ®å¯èƒ½å­˜åœ¨çŸ­æš‚ä¸ä¸€è‡´
- é€šè¿‡ä¸šåŠ¡é€»è¾‘å’Œå¼‚æ­¥åŒæ­¥ä¿è¯æœ€ç»ˆä¸€è‡´æ€§
- é‡è¦æ•°æ®ï¼ˆå¦‚é‡‘é¢ï¼‰ä¿æŒå¼ºä¸€è‡´æ€§

### 2. å­˜å‚¨æˆæœ¬
- å†—ä½™å­˜å‚¨ä¼šå¢åŠ å­˜å‚¨ç©ºé—´ï¼ˆçº¦20-30%ï¼‰
- ä½†æŸ¥è¯¢æ€§èƒ½æå‡å¸¦æ¥çš„æ”¶ç›Šè¿œå¤§äºå­˜å‚¨æˆæœ¬

### 3. å¼€å‘å¤æ‚åº¦
- éœ€è¦ç»´æŠ¤æ•°æ®åŒæ­¥é€»è¾‘
- é€šè¿‡ç»Ÿä¸€çš„äº‹ä»¶æœºåˆ¶ç®€åŒ–å¤æ‚åº¦

## ğŸ”§ ç»´æŠ¤è„šæœ¬

### æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
```sql
-- æ£€æŸ¥è®¢å•ä¸æƒé™å…³è”çš„ä¸€è‡´æ€§
SELECT 
    oi.order_no,
    oi.status,
    COUNT(oca.id) as content_count
FROM order_info oi
LEFT JOIN order_content_association oca ON oi.id = oca.order_id 
WHERE oi.deleted = 0 AND oi.status = 'PAID'
GROUP BY oi.id
HAVING content_count = 0;  -- å·²æ”¯ä»˜ä½†æ— å†…å®¹æƒé™çš„å¼‚å¸¸è®¢å•
```

### è¿‡æœŸæƒé™æ¸…ç†
```sql
-- æ ‡è®°è¿‡æœŸçš„ä¸´æ—¶æƒé™
UPDATE order_content_association 
SET status = 'EXPIRED' 
WHERE status = 'ACTIVE' 
  AND access_end_time IS NOT NULL 
  AND access_end_time < NOW()
  AND deleted = 0;
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [è®¢å•çŠ¶æ€æœºè®¾è®¡](../../Document/order-state-machine.md)
- [è®¢å•APIæ–‡æ¡£](../../Document/api/order-api.md)
- [å»è¿è¡¨åŒ–è®¾è®¡æŒ‡å—](../../Document/no-join-design-guide.md) 