<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gig.collide.social.infrastructure.mapper.SocialPostInteractionMapper">

    <!-- 基础结果映射 -->
    <resultMap id="BaseResultMap" type="com.gig.collide.social.domain.entity.SocialPostInteraction">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="post_id" property="postId" jdbcType="BIGINT"/>
        <result column="user_id" property="userId" jdbcType="BIGINT"/>
        <result column="interaction_type" property="interactionType" jdbcType="VARCHAR"/>
        <result column="interaction_status" property="interactionStatus" jdbcType="TINYINT"/>
        <result column="user_nickname" property="userNickname" jdbcType="VARCHAR"/>
        <result column="user_avatar" property="userAvatar" jdbcType="VARCHAR"/>
        <result column="post_author_id" property="postAuthorId" jdbcType="BIGINT"/>
        <result column="post_type" property="postType" jdbcType="VARCHAR"/>
        <result column="post_title" property="postTitle" jdbcType="VARCHAR"/>
        <result column="interaction_content" property="interactionContent" jdbcType="VARCHAR"/>
        <result column="device_info" property="deviceInfo" jdbcType="VARCHAR"/>
        <result column="ip_address" property="ipAddress" jdbcType="VARCHAR"/>
        <result column="created_time" property="createdTime" jdbcType="TIMESTAMP"/>
        <result column="updated_time" property="updatedTime" jdbcType="TIMESTAMP"/>
        <result column="deleted" property="deleted" jdbcType="TINYINT"/>
    </resultMap>

    <!-- 用户互动统计结果映射 -->
    <resultMap id="UserInteractionStatsResultMap" type="com.gig.collide.social.infrastructure.mapper.SocialPostInteractionMapper$UserInteractionStats">
        <result column="user_id" property="userId" jdbcType="BIGINT"/>
        <result column="user_nickname" property="userNickname" jdbcType="VARCHAR"/>
        <result column="user_avatar" property="userAvatar" jdbcType="VARCHAR"/>
        <result column="interaction_count" property="interactionCount" jdbcType="BIGINT"/>
        <result column="last_interaction_time" property="lastInteractionTime" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- 通用列 -->
    <sql id="Base_Column_List">
        id, post_id, user_id, interaction_type, interaction_status,
        user_nickname, user_avatar, post_author_id, post_type, post_title,
        interaction_content, device_info, ip_address, 
        created_time, updated_time, deleted
    </sql>

    <!-- 查询用户对动态的互动状态 - 无连表 -->
    <select id="selectUserInteraction" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_social_post_interaction
        WHERE deleted = 0
        AND user_id = #{userId}
        AND post_id = #{postId}
        AND interaction_type = #{interactionType}
        ORDER BY updated_time DESC
        LIMIT 1
    </select>

    <!-- 批量查询用户对多个动态的互动状态 - 无连表 -->
    <select id="selectUserInteractionsBatch" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_social_post_interaction
        WHERE deleted = 0
        AND user_id = #{userId}
        AND interaction_type = #{interactionType}
        AND interaction_status = 1
        <if test="postIds != null and postIds.size() > 0">
            AND post_id IN
            <foreach collection="postIds" item="postId" open="(" separator="," close=")">
                #{postId}
            </foreach>
        </if>
        ORDER BY updated_time DESC
    </select>

    <!-- 分页查询动态的互动记录 - 无连表 -->
    <select id="selectPostInteractionsPage" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_social_post_interaction
        WHERE deleted = 0
        AND post_id = #{postId}
        <if test="interactionType != null">
            AND interaction_type = #{interactionType}
        </if>
        <if test="interactionStatus != null">
            AND interaction_status = #{interactionStatus}
        </if>
        ORDER BY created_time DESC
    </select>

    <!-- 分页查询用户的互动历史 - 无连表 -->
    <select id="selectUserInteractionHistoryPage" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_social_post_interaction
        WHERE deleted = 0
        AND user_id = #{userId}
        <if test="interactionType != null">
            AND interaction_type = #{interactionType}
        </if>
        <if test="startTime != null">
            AND created_time >= #{startTime}
        </if>
        <if test="endTime != null">
            AND created_time &lt;= #{endTime}
        </if>
        ORDER BY created_time DESC
    </select>

    <!-- 分页查询作者收到的互动 - 无连表 -->
    <select id="selectAuthorReceivedInteractionsPage" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_social_post_interaction
        WHERE deleted = 0
        AND post_author_id = #{postAuthorId}
        AND interaction_status = 1
        <if test="interactionType != null">
            AND interaction_type = #{interactionType}
        </if>
        <if test="startTime != null">
            AND created_time >= #{startTime}
        </if>
        <if test="endTime != null">
            AND created_time &lt;= #{endTime}
        </if>
        ORDER BY created_time DESC
    </select>

    <!-- 统计动态的互动数量 - 无连表 -->
    <select id="countPostInteractions" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM t_social_post_interaction
        WHERE deleted = 0
        AND post_id = #{postId}
        <if test="interactionType != null">
            AND interaction_type = #{interactionType}
        </if>
        <if test="interactionStatus != null">
            AND interaction_status = #{interactionStatus}
        </if>
    </select>

    <!-- 统计用户的互动数量 - 无连表 -->
    <select id="countUserInteractions" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM t_social_post_interaction
        WHERE deleted = 0
        AND user_id = #{userId}
        <if test="interactionType != null">
            AND interaction_type = #{interactionType}
        </if>
        <if test="interactionStatus != null">
            AND interaction_status = #{interactionStatus}
        </if>
        <if test="startTime != null">
            AND created_time >= #{startTime}
        </if>
        <if test="endTime != null">
            AND created_time &lt;= #{endTime}
        </if>
    </select>

    <!-- 更新或插入互动记录（幂等操作） -->
    <insert id="upsertInteraction" parameterType="com.gig.collide.social.domain.entity.SocialPostInteraction">
        INSERT INTO t_social_post_interaction (
            post_id, user_id, interaction_type, interaction_status,
            user_nickname, user_avatar, post_author_id, post_type, post_title,
            interaction_content, device_info, ip_address, created_time, updated_time
        ) VALUES (
            #{postId}, #{userId}, #{interactionType}, #{interactionStatus},
            #{userNickname}, #{userAvatar}, #{postAuthorId}, #{postType}, #{postTitle},
            #{interactionContent}, #{deviceInfo}, #{ipAddress}, NOW(), NOW()
        )
        ON DUPLICATE KEY UPDATE
            interaction_status = VALUES(interaction_status),
            interaction_content = VALUES(interaction_content),
            device_info = VALUES(device_info),
            ip_address = VALUES(ip_address),
            updated_time = NOW()
    </insert>

    <!-- 取消用户对动态的特定互动 - 无连表 -->
    <update id="cancelUserInteraction">
        UPDATE t_social_post_interaction 
        SET interaction_status = 0,
            updated_time = NOW()
        WHERE user_id = #{userId}
        AND post_id = #{postId}
        AND interaction_type = #{interactionType}
        AND deleted = 0
    </update>

    <!-- 批量更新用户信息冗余字段 - 无连表 -->
    <update id="batchUpdateUserInfo">
        UPDATE t_social_post_interaction 
        SET user_nickname = #{userNickname},
            user_avatar = #{userAvatar},
            updated_time = NOW()
        WHERE user_id = #{userId}
        AND deleted = 0
    </update>

    <!-- 批量更新动态信息冗余字段 - 无连表 -->
    <update id="batchUpdatePostInfo">
        UPDATE t_social_post_interaction 
        SET post_author_id = #{postAuthorId},
            post_type = #{postType},
            post_title = #{postTitle},
            updated_time = NOW()
        WHERE post_id = #{postId}
        AND deleted = 0
    </update>

    <!-- 清理过期的浏览记录 - 无连表 -->
    <delete id="cleanExpiredViewRecords">
        DELETE FROM t_social_post_interaction 
        WHERE interaction_type = 'VIEW'
        AND created_time &lt; #{expireTime}
    </delete>

    <!-- 查询活跃用户互动排行榜 - 无连表 -->
    <select id="selectActiveUserRanking" resultMap="UserInteractionStatsResultMap">
        SELECT 
            user_id,
            user_nickname,
            user_avatar,
            COUNT(*) as interaction_count,
            MAX(created_time) as last_interaction_time
        FROM t_social_post_interaction
        WHERE deleted = 0
        AND interaction_status = 1
        <if test="interactionType != null">
            AND interaction_type = #{interactionType}
        </if>
        <if test="startTime != null">
            AND created_time >= #{startTime}
        </if>
        <if test="endTime != null">
            AND created_time &lt;= #{endTime}
        </if>
        GROUP BY user_id, user_nickname, user_avatar
        ORDER BY interaction_count DESC, last_interaction_time DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

</mapper> 