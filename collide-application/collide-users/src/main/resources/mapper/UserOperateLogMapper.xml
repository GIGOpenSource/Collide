<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gig.collide.users.infrastructure.mapper.UserOperateLogMapper">
    <!-- Generate by Collide Team Date: 2024-01-27 去连表设计 v2.0.0 -->

    <resultMap id="userOperateLogMap" type="com.gig.collide.users.domain.entity.UserOperateLog">
        <result property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="operateType" column="operate_type"/>
        <result property="operateDesc" column="operate_desc"/>
        <result property="ipAddress" column="ip_address"/>
        <result property="userAgent" column="user_agent"/>
        <result property="createTime" column="create_time"/>
    </resultMap>

    <!-- 基础字段列表 -->
    <sql id="Base_Column_List">
        id, user_id, operate_type, operate_desc, ip_address, user_agent, create_time
    </sql>

    <!-- 根据用户ID查询操作日志 -->
    <select id="selectByUserId" resultMap="userOperateLogMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_user_operate_log USE INDEX (idx_user_id)
        WHERE user_id = #{userId}
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 根据操作类型查询日志 -->
    <select id="selectByOperateType" resultMap="userOperateLogMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_user_operate_log USE INDEX (idx_operate_type)
        WHERE operate_type = #{operateType}
        <if test="startTime != null">
            AND create_time >= #{startTime}
        </if>
        <if test="endTime != null">
            AND create_time <= #{endTime}
        </if>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 统计用户操作次数 -->
    <select id="countUserOperations" resultType="long">
        SELECT COUNT(*) FROM t_user_operate_log 
        WHERE user_id = #{userId}
        <if test="operateType != null and operateType != ''">
            AND operate_type = #{operateType}
        </if>
        <if test="startTime != null">
            AND create_time >= #{startTime}
        </if>
        <if test="endTime != null">
            AND create_time <= #{endTime}
        </if>
    </select>

    <!-- 获取操作统计信息 -->
    <select id="getOperateStatistics" resultType="map">
        SELECT 
            operate_type,
            COUNT(*) as count,
            COUNT(DISTINCT user_id) as unique_users,
            DATE(create_time) as operate_date
        FROM t_user_operate_log
        WHERE create_time BETWEEN #{startTime} AND #{endTime}
        GROUP BY operate_type, DATE(create_time)
        ORDER BY operate_date DESC, count DESC
    </select>

    <!-- 删除过期日志（物理删除，释放存储空间）-->
    <delete id="deleteExpiredLogs">
        DELETE FROM t_user_operate_log 
        WHERE create_time < #{expireTime}
        LIMIT 10000
    </delete>

</mapper> 