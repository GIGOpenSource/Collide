<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gig.collide.users.infrastructure.mapper.UserUnifiedMapper">

    <!-- 根据用户名查询用户 -->
    <select id="findByUsername" parameterType="string" resultType="com.gig.collide.users.domain.entity.UserUnified">
        SELECT * FROM t_user_unified 
        WHERE username = #{username} AND deleted = 0
    </select>

    <!-- 根据邮箱查询用户 -->
    <select id="findByEmail" parameterType="string" resultType="com.gig.collide.users.domain.entity.UserUnified">
        SELECT * FROM t_user_unified 
        WHERE email = #{email} AND deleted = 0
    </select>

    <!-- 根据手机号查询用户 -->
    <select id="findByPhone" parameterType="string" resultType="com.gig.collide.users.domain.entity.UserUnified">
        SELECT * FROM t_user_unified 
        WHERE phone = #{phone} AND deleted = 0
    </select>

    <!-- 根据邀请码查询用户 -->
    <select id="findByInviteCode" parameterType="string" resultType="com.gig.collide.users.domain.entity.UserUnified">
        SELECT * FROM t_user_unified 
        WHERE invite_code = #{inviteCode} AND deleted = 0
    </select>

    <!-- 根据手机号和密码查询用户 -->
    <select id="findByPhoneAndPassword" resultType="com.gig.collide.users.domain.entity.UserUnified">
        SELECT * FROM t_user_unified 
        WHERE phone = #{phone} AND password_hash = #{passwordHash} AND deleted = 0
    </select>

    <!-- 更新用户统计信息 -->
    <update id="updateUserStatistics">
        CALL UpdateUserStatistics(#{userId}, #{fieldName}, #{incrementValue})
    </update>

    <!-- 更新最后登录时间 -->
    <update id="updateLastLoginTime">
        UPDATE t_user_unified 
        SET last_login_time = NOW(), login_count = login_count + 1, update_time = NOW()
        WHERE id = #{userId} AND deleted = 0
    </update>

</mapper> 