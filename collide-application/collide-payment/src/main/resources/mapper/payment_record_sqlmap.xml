<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gig.collide.payment.infrastructure.mapper.PaymentRecordMapper">
    <!-- Generate by Collide Team Date: 2024-01-27 去连表设计 v2.0.0 -->

    <resultMap id="paymentRecordMap" type="com.gig.collide.payment.infrastructure.entity.PaymentRecord">
        <!-- 基础字段 -->
        <result property="id" column="id"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="deleted" column="deleted"/>
        <result property="version" column="version"/>

        <!-- 订单信息 -->
        <result property="orderNo" column="order_no"/>
        <result property="transactionNo" column="transaction_no"/>
        <result property="internalTransactionNo" column="internal_transaction_no"/>

        <!-- 用户信息（冗余字段）-->
        <result property="userId" column="user_id"/>
        <result property="userName" column="user_name"/>
        <result property="userPhone" column="user_phone"/>
        <result property="userEmail" column="user_email"/>

        <!-- 订单信息（冗余字段）-->
        <result property="orderTitle" column="order_title"/>
        <result property="productName" column="product_name"/>
        <result property="productType" column="product_type"/>
        <result property="merchantId" column="merchant_id"/>
        <result property="merchantName" column="merchant_name"/>

        <!-- 金额信息 -->
        <result property="payAmount" column="pay_amount"/>
        <result property="actualPayAmount" column="actual_pay_amount"/>
        <result property="discountAmount" column="discount_amount"/>
        <result property="currencyCode" column="currency_code"/>

        <!-- 支付信息 -->
        <result property="payType" column="pay_type"/>
        <result property="payScene" column="pay_scene"/>
        <result property="payMethod" column="pay_method"/>
        <result property="payStatus" column="pay_status"/>

        <!-- 时间信息 -->
        <result property="payTime" column="pay_time"/>
        <result property="expireTime" column="expire_time"/>

        <!-- 网络信息 -->
        <result property="clientIp" column="client_ip"/>
        <result property="userAgent" column="user_agent"/>
        <result property="deviceInfo" column="device_info"/>

        <!-- 回调信息 -->
        <result property="notifyUrl" column="notify_url"/>
        <result property="returnUrl" column="return_url"/>
        <result property="notifyCount" column="notify_count"/>
        <result property="maxNotifyCount" column="max_notify_count"/>
        <result property="lastNotifyTime" column="last_notify_time"/>

        <!-- 风控信息 -->
        <result property="riskLevel" column="risk_level"/>
        <result property="riskScore" column="risk_score"/>
        <result property="failureCode" column="failure_code"/>
        <result property="failureReason" column="failure_reason"/>

        <!-- 扩展信息 -->
        <result property="remark" column="remark"/>
        <result property="extraData" column="extra_data"/>
        <result property="businessData" column="business_data"/>
        <result property="envProfile" column="env_profile"/>
    </resultMap>

    <!-- 根据订单号和用户ID查询（去连表设计）-->
    <select id="selectByOrderNoAndUserId" resultMap="paymentRecordMap">
        SELECT * FROM t_payment_record 
        WHERE deleted = 0
        <if test="orderNo != null and orderNo != ''">
            AND order_no = #{orderNo}
        </if>
        <if test="userId != null">
            AND user_id = #{userId}
        </if>
        ORDER BY create_time DESC
        LIMIT 1
    </select>

    <!-- 根据内部交易流水号查询 -->
    <select id="selectByInternalTransactionNo" resultMap="paymentRecordMap">
        SELECT * FROM t_payment_record 
        WHERE deleted = 0 AND internal_transaction_no = #{internalTransactionNo}
    </select>

    <!-- 根据用户ID查询支付记录列表 -->
    <select id="selectByUserId" resultMap="paymentRecordMap">
        SELECT * FROM t_payment_record 
        WHERE deleted = 0 AND user_id = #{userId}
        <if test="payStatus != null and payStatus != ''">
            AND pay_status = #{payStatus}
        </if>
        ORDER BY create_time DESC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 根据用户名查询支付记录列表（利用冗余字段）-->
    <select id="selectByUserName" resultMap="paymentRecordMap">
        SELECT * FROM t_payment_record 
        WHERE deleted = 0 AND user_name = #{userName}
        <if test="payStatus != null and payStatus != ''">
            AND pay_status = #{payStatus}
        </if>
        ORDER BY create_time DESC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 根据商户ID查询支付记录列表（利用冗余字段）-->
    <select id="selectByMerchantId" resultMap="paymentRecordMap">
        SELECT * FROM t_payment_record 
        WHERE deleted = 0 AND merchant_id = #{merchantId}
        <if test="payStatus != null and payStatus != ''">
            AND pay_status = #{payStatus}
        </if>
        <if test="startTime != null">
            AND create_time >= #{startTime}
        </if>
        <if test="endTime != null">
            AND create_time &lt;= #{endTime}
        </if>
        ORDER BY create_time DESC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 查询待支付订单（需要过期处理）-->
    <select id="selectPendingPayments" resultMap="paymentRecordMap">
        SELECT * FROM t_payment_record 
        WHERE deleted = 0 
        AND pay_status = 'PENDING'
        AND expire_time &lt; NOW()
        ORDER BY create_time ASC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 统计商户支付金额（利用冗余字段避免联表）-->
    <select id="sumMerchantPayAmount" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(pay_amount), 0) 
        FROM t_payment_record 
        WHERE deleted = 0 
        AND merchant_id = #{merchantId}
        AND pay_status = 'SUCCESS'
        <if test="startDate != null and startDate != ''">
            AND DATE(create_time) >= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND DATE(create_time) &lt;= #{endDate}
        </if>
    </select>

    <!-- 统计支付方式成功率 -->
    <select id="calculateSuccessRateByPayType" resultType="java.util.Map">
        SELECT 
            pay_type,
            COUNT(*) as total_count,
            SUM(CASE WHEN pay_status = 'SUCCESS' THEN 1 ELSE 0 END) as success_count,
            ROUND(SUM(CASE WHEN pay_status = 'SUCCESS' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as success_rate
        FROM t_payment_record 
        WHERE deleted = 0
        <if test="payType != null and payType != ''">
            AND pay_type = #{payType}
        </if>
        <if test="startTime != null">
            AND create_time >= #{startTime}
        </if>
        <if test="endTime != null">
            AND create_time &lt;= #{endTime}
        </if>
        GROUP BY pay_type
    </select>

    <!-- 更新支付状态（乐观锁）-->
    <update id="updatePayStatus">
        UPDATE t_payment_record 
        SET pay_status = #{payStatus},
            actual_pay_amount = #{actualPayAmount},
            pay_time = #{payTime},
            transaction_no = #{transactionNo},
            update_time = NOW(),
            version = version + 1
        WHERE id = #{id} AND version = #{version} AND deleted = 0
    </update>

    <!-- 更新回调信息 -->
    <update id="updateNotifyInfo">
        UPDATE t_payment_record 
        SET notify_count = notify_count + 1,
            last_notify_time = NOW(),
            update_time = NOW(),
            version = version + 1
        WHERE id = #{id} AND deleted = 0
    </update>

    <!-- 更新风控信息 -->
    <update id="updateRiskInfo">
        UPDATE t_payment_record 
        SET risk_level = #{riskLevel},
            risk_score = #{riskScore},
            failure_code = #{failureCode},
            failure_reason = #{failureReason},
            update_time = NOW(),
            version = version + 1
        WHERE id = #{id} AND deleted = 0
    </update>

    <!-- 批量更新过期订单状态 -->
    <update id="batchUpdateExpiredOrders">
        UPDATE t_payment_record 
        SET pay_status = 'EXPIRED',
            update_time = NOW(),
            version = version + 1
        WHERE deleted = 0 
        AND pay_status = 'PENDING'
        AND expire_time &lt; NOW()
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </update>

    <!-- 批量更新失败通知状态 -->
    <update id="batchUpdateFailedNotifications">
        UPDATE t_payment_record 
        SET pay_status = 'NOTIFY_FAILED',
            update_time = NOW(),
            version = version + 1
        WHERE deleted = 0 
        AND pay_status = 'SUCCESS'
        AND notify_count >= max_notify_count
        AND last_notify_time &lt; DATE_SUB(NOW(), INTERVAL 1 HOUR)
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </update>

    <!-- 复杂条件查询支付记录 -->
    <select id="selectByMultipleConditions" resultMap="paymentRecordMap">
        <bind name="pattern" value="'%' + keyword + '%'" />
        SELECT * FROM t_payment_record 
        WHERE deleted = 0
        <if test="userId != null">
            AND user_id = #{userId}
        </if>
        <if test="userName != null and userName != ''">
            AND user_name = #{userName}
        </if>
        <if test="merchantId != null">
            AND merchant_id = #{merchantId}
        </if>
        <if test="payType != null and payType != ''">
            AND pay_type = #{payType}
        </if>
        <if test="payStatus != null and payStatus != ''">
            AND pay_status = #{payStatus}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (order_no LIKE #{pattern} 
                 OR user_name LIKE #{pattern} 
                 OR product_name LIKE #{pattern}
                 OR merchant_name LIKE #{pattern})
        </if>
        <if test="startTime != null">
            AND create_time >= #{startTime}
        </if>
        <if test="endTime != null">
            AND create_time &lt;= #{endTime}
        </if>
        ORDER BY create_time DESC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

</mapper> 