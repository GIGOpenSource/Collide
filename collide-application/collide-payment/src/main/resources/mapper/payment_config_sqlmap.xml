<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gig.collide.payment.infrastructure.mapper.PaymentConfigMapper">
    <!-- Generate by Collide Team Date: 2024-01-27 去连表设计 v2.0.0 -->

    <resultMap id="paymentConfigMap" type="com.gig.collide.payment.infrastructure.entity.PaymentConfig">
        <!-- 基础字段 -->
        <result property="id" column="id"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="deleted" column="deleted"/>
        <result property="version" column="version"/>

        <!-- 配置基础信息 -->
        <result property="configKey" column="config_key"/>
        <result property="configType" column="config_type"/>
        <result property="configName" column="config_name"/>
        <result property="configValue" column="config_value"/>
        <result property="configStatus" column="config_status"/>

        <!-- 商户信息（冗余字段）-->
        <result property="merchantId" column="merchant_id"/>
        <result property="merchantName" column="merchant_name"/>
        <result property="merchantType" column="merchant_type"/>

        <!-- 环境信息 -->
        <result property="envProfile" column="env_profile"/>
        <result property="platform" column="platform"/>

        <!-- 支付方式配置 -->
        <result property="payType" column="pay_type"/>
        <result property="payScene" column="pay_scene"/>
        <result property="supportedMethods" column="supported_methods"/>

        <!-- 限额配置 -->
        <result property="minAmount" column="min_amount"/>
        <result property="maxAmount" column="max_amount"/>
        <result property="dailyLimit" column="daily_limit"/>
        <result property="monthlyLimit" column="monthly_limit"/>

        <!-- 费率配置 -->
        <result property="feeRate" column="fee_rate"/>
        <result property="fixedFee" column="fixed_fee"/>
        <result property="feeType" column="fee_type"/>

        <!-- 回调配置 -->
        <result property="notifyUrl" column="notify_url"/>
        <result property="maxRetryCount" column="max_retry_count"/>
        <result property="retryInterval" column="retry_interval"/>
        <result property="timeoutSeconds" column="timeout_seconds"/>

        <!-- 安全配置 -->
        <result property="encryptKey" column="encrypt_key"/>
        <result property="signKey" column="sign_key"/>
        <result property="algorithm" column="algorithm"/>
        <result property="charset" column="charset"/>

        <!-- 扩展配置 -->
        <result property="extraConfig" column="extra_config"/>
        <result property="remark" column="remark"/>

        <!-- 生效时间 -->
        <result property="effectiveTime" column="effective_time"/>
        <result property="expireTime" column="expire_time"/>

        <!-- 操作信息 -->
        <result property="operatorId" column="operator_id"/>
        <result property="operatorName" column="operator_name"/>
    </resultMap>

    <!-- 根据配置key查询 -->
    <select id="selectByConfigKey" resultMap="paymentConfigMap">
        <![CDATA[
        SELECT * FROM t_payment_config
        WHERE deleted = 0 AND config_key = #{configKey}
        ]]>
        <if test="envProfile != null and envProfile != ''">
            AND env_profile = #{envProfile}
        </if>
        <![CDATA[
        ORDER BY create_time DESC
        LIMIT 1
        ]]>
    </select>

    <!-- 根据商户ID和配置类型查询（利用冗余字段）-->
    <select id="selectByMerchantAndType" resultMap="paymentConfigMap">
        <![CDATA[
        SELECT * FROM t_payment_config
        WHERE deleted = 0
        AND merchant_id = #{merchantId}
        AND config_type = #{configType}
        ]]>
        <if test="payType != null and payType != ''">
            AND pay_type = #{payType}
        </if>
        <if test="envProfile != null and envProfile != ''">
            AND env_profile = #{envProfile}
        </if>
        <![CDATA[
        AND config_status = 'ACTIVE'
        AND (effective_time IS NULL OR effective_time <= NOW())
        AND (expire_time IS NULL OR expire_time > NOW())
        ORDER BY create_time DESC
        ]]>
    </select>

    <!-- 根据商户名称查询配置（利用冗余字段）-->
    <select id="selectByMerchantName" resultMap="paymentConfigMap">
        <![CDATA[
        SELECT * FROM t_payment_config
        WHERE deleted = 0
        AND merchant_name = #{merchantName}
        ]]>
        <if test="configType != null and configType != ''">
            AND config_type = #{configType}
        </if>
        <if test="configStatus != null and configStatus != ''">
            AND config_status = #{configStatus}
        </if>
        <![CDATA[
        ORDER BY create_time DESC
        ]]>
        <if test="limit != null and limit &gt; 0">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 查询有效的支付配置 -->
    <select id="selectActiveConfigs" resultMap="paymentConfigMap">
        <![CDATA[
        SELECT * FROM t_payment_config
        WHERE deleted = 0
        AND config_status = 'ACTIVE'
        AND (effective_time IS NULL OR effective_time <= NOW())
        AND (expire_time IS NULL OR expire_time > NOW())
        ]]>
        <if test="configType != null and configType != ''">
            AND config_type = #{configType}
        </if>
        <if test="payType != null and payType != ''">
            AND pay_type = #{payType}
        </if>
        <if test="envProfile != null and envProfile != ''">
            AND env_profile = #{envProfile}
        </if>
        <![CDATA[
        ORDER BY create_time DESC
        ]]>
    </select>

    <!-- 查询即将过期的配置 -->
    <select id="selectExpiringConfigs" resultMap="paymentConfigMap">
        <![CDATA[
        SELECT * FROM t_payment_config
        WHERE deleted = 0
          AND config_status = 'ACTIVE'
          AND expire_time IS NOT NULL
          AND expire_time BETWEEN NOW() AND DATE_ADD(NOW(), INTERVAL #{warningDays} DAY)
        ORDER BY expire_time ASC
        ]]>
    </select>

    <!-- 统计商户配置数量（利用冗余字段）-->
    <select id="countByMerchantId" resultType="java.lang.Integer">
        <![CDATA[
        SELECT COUNT(*)
        FROM t_payment_config
        WHERE deleted = 0
        AND merchant_id = #{merchantId}
        ]]>
        <if test="configStatus != null and configStatus != ''">
            AND config_status = #{configStatus}
        </if>
    </select>

    <!-- 查询配置类型统计 -->
    <select id="selectConfigTypeStats" resultType="java.util.Map">
        <![CDATA[
        SELECT
            config_type,
            COUNT(*) as total_count,
            SUM(CASE WHEN config_status = 'ACTIVE' THEN 1 ELSE 0 END) as active_count,
            SUM(CASE WHEN config_status = 'INACTIVE' THEN 1 ELSE 0 END) as inactive_count
        FROM t_payment_config
        WHERE deleted = 0
        ]]>
        <if test="envProfile != null and envProfile != ''">
            AND env_profile = #{envProfile}
        </if>
        <![CDATA[
        GROUP BY config_type
        ORDER BY total_count DESC
        ]]>
    </select>

    <!-- 更新配置状态 -->
    <update id="updateConfigStatus">
        <![CDATA[
        UPDATE t_payment_config
        SET config_status = #{configStatus},
            operator_id = #{operatorId},
            operator_name = #{operatorName},
            update_time = NOW(),
            version = version + 1
        WHERE id = #{id} AND version = #{version} AND deleted = 0
        ]]>
    </update>

    <!-- 更新配置值 -->
    <update id="updateConfigValue">
        <![CDATA[
        UPDATE t_payment_config
        SET config_value = #{configValue},
            extra_config = #{extraConfig},
            operator_id = #{operatorId},
            operator_name = #{operatorName},
            update_time = NOW(),
            version = version + 1
        WHERE id = #{id} AND version = #{version} AND deleted = 0
        ]]>
    </update>

    <!-- 批量更新过期配置状态 -->
    <update id="batchUpdateExpiredConfigs">
        <![CDATA[
        UPDATE t_payment_config
        SET config_status = 'EXPIRED',
            update_time = NOW(),
            version = version + 1
        WHERE deleted = 0
        AND config_status = 'ACTIVE'
        AND expire_time IS NOT NULL
        AND expire_time <= NOW()
        ]]>
        <if test="limit != null and limit &gt; 0">
            LIMIT #{limit}
        </if>
    </update>

    <!-- 复杂条件查询配置 -->
    <select id="selectByMultipleConditions" resultMap="paymentConfigMap">
        <bind name="pattern" value="'%' + keyword + '%'" />
        <![CDATA[
        SELECT * FROM t_payment_config
        WHERE deleted = 0
        ]]>
        <if test="merchantId != null">
            AND merchant_id = #{merchantId}
        </if>
        <if test="merchantName != null and merchantName != ''">
            AND merchant_name = #{merchantName}
        </if>
        <if test="configType != null and configType != ''">
            AND config_type = #{configType}
        </if>
        <if test="configStatus != null and configStatus != ''">
            AND config_status = #{configStatus}
        </if>
        <if test="payType != null and payType != ''">
            AND pay_type = #{payType}
        </if>
        <if test="envProfile != null and envProfile != ''">
            AND env_profile = #{envProfile}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (config_key LIKE #{pattern}
            OR config_name LIKE #{pattern}
            OR merchant_name LIKE #{pattern}
            OR remark LIKE #{pattern})
        </if>
        <![CDATA[
        ORDER BY create_time DESC
        ]]>
        <if test="limit != null and limit &gt; 0">
            LIMIT #{limit}
        </if>
    </select>
</mapper>