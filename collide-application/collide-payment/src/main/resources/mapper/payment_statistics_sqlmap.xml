<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gig.collide.payment.infrastructure.mapper.PaymentStatisticsMapper">
    <!-- Generate by Collide Team Date: 2024-01-27 去连表设计 v2.0.0 -->

    <resultMap id="paymentStatisticsMap" type="com.gig.collide.payment.infrastructure.entity.PaymentStatistics">
        <!-- 基础字段 -->
        <result property="id" column="id"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="deleted" column="deleted"/>
        <result property="version" column="version"/>

        <!-- 统计维度 -->
        <result property="statDate" column="stat_date"/>
        <result property="statHour" column="stat_hour"/>
        <result property="statType" column="stat_type"/>

        <!-- 商户信息（冗余字段）-->
        <result property="merchantId" column="merchant_id"/>
        <result property="merchantName" column="merchant_name"/>

        <!-- 支付方式信息 -->
        <result property="payType" column="pay_type"/>
        <result property="payScene" column="pay_scene"/>

        <!-- 基础统计数据 -->
        <result property="totalCount" column="total_count"/>
        <result property="successCount" column="success_count"/>
        <result property="failedCount" column="failed_count"/>
        <result property="pendingCount" column="pending_count"/>
        <result property="cancelCount" column="cancel_count"/>

        <!-- 金额统计 -->
        <result property="totalAmount" column="total_amount"/>
        <result property="successAmount" column="success_amount"/>
        <result property="refundAmount" column="refund_amount"/>
        <result property="feeAmount" column="fee_amount"/>

        <!-- 成功率统计 -->
        <result property="successRate" column="success_rate"/>
        <result property="avgAmount" column="avg_amount"/>

        <!-- 时间统计 -->
        <result property="avgProcessTime" column="avg_process_time"/>
        <result property="maxProcessTime" column="max_process_time"/>
        <result property="minProcessTime" column="min_process_time"/>

        <!-- 用户统计 -->
        <result property="uniqueUserCount" column="unique_user_count"/>
        <result property="newUserCount" column="new_user_count"/>

        <!-- 环境信息 -->
        <result property="envProfile" column="env_profile"/>

        <!-- 扩展统计 -->
        <result property="extraStats" column="extra_stats"/>
        <result property="remark" column="remark"/>
    </resultMap>

    <!-- 根据日期和统计类型查询 -->
    <select id="selectByDateAndType" resultMap="paymentStatisticsMap">
        SELECT * FROM t_payment_statistics 
        WHERE deleted = 0 
        AND stat_date = #{statDate}
        AND stat_type = #{statType}
        <if test="merchantId != null">
            AND merchant_id = #{merchantId}
        </if>
        <if test="payType != null and payType != ''">
            AND pay_type = #{payType}
        </if>
    </select>

    <!-- 根据商户ID查询统计（利用冗余字段）-->
    <select id="selectByMerchantId" resultMap="paymentStatisticsMap">
        SELECT * FROM t_payment_statistics 
        WHERE deleted = 0 
        AND merchant_id = #{merchantId}
        <if test="statType != null and statType != ''">
            AND stat_type = #{statType}
        </if>
        <if test="startDate != null and startDate != ''">
            AND stat_date >= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND stat_date &lt;= #{endDate}
        </if>
        ORDER BY stat_date DESC, stat_hour DESC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 根据商户名称查询统计（利用冗余字段）-->
    <select id="selectByMerchantName" resultMap="paymentStatisticsMap">
        SELECT * FROM t_payment_statistics 
        WHERE deleted = 0 
        AND merchant_name = #{merchantName}
        <if test="payType != null and payType != ''">
            AND pay_type = #{payType}
        </if>
        <if test="startDate != null and startDate != ''">
            AND stat_date >= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND stat_date &lt;= #{endDate}
        </if>
        ORDER BY stat_date DESC
    </select>

    <!-- 查询日统计汇总 -->
    <select id="selectDailySummary" resultType="java.util.Map">
        SELECT 
            stat_date,
            SUM(total_count) as total_count,
            SUM(success_count) as success_count,
            SUM(total_amount) as total_amount,
            SUM(success_amount) as success_amount,
            ROUND(SUM(success_count) * 100.0 / SUM(total_count), 2) as success_rate,
            COUNT(DISTINCT merchant_id) as merchant_count
        FROM t_payment_statistics 
        WHERE deleted = 0
        AND stat_type = 'DAILY'
        <if test="startDate != null and startDate != ''">
            AND stat_date >= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND stat_date &lt;= #{endDate}
        </if>
        <if test="payType != null and payType != ''">
            AND pay_type = #{payType}
        </if>
        GROUP BY stat_date
        ORDER BY stat_date DESC
    </select>

    <!-- 查询支付方式统计排行 -->
    <select id="selectPayTypeRanking" resultType="java.util.Map">
        SELECT 
            pay_type,
            SUM(total_count) as total_count,
            SUM(success_count) as success_count,
            SUM(success_amount) as success_amount,
            ROUND(SUM(success_count) * 100.0 / SUM(total_count), 2) as success_rate,
            ROUND(SUM(success_amount) / SUM(success_count), 2) as avg_amount
        FROM t_payment_statistics 
        WHERE deleted = 0
        <if test="startDate != null and startDate != ''">
            AND stat_date >= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND stat_date &lt;= #{endDate}
        </if>
        <if test="statType != null and statType != ''">
            AND stat_type = #{statType}
        </if>
        GROUP BY pay_type
        ORDER BY success_amount DESC
    </select>

    <!-- 查询商户排行榜（利用冗余字段）-->
    <select id="selectMerchantRanking" resultType="java.util.Map">
        SELECT 
            merchant_id,
            merchant_name,
            SUM(total_count) as total_count,
            SUM(success_count) as success_count,
            SUM(success_amount) as success_amount,
            ROUND(SUM(success_count) * 100.0 / SUM(total_count), 2) as success_rate
        FROM t_payment_statistics 
        WHERE deleted = 0
        <if test="startDate != null and startDate != ''">
            AND stat_date >= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND stat_date &lt;= #{endDate}
        </if>
        <if test="statType != null and statType != ''">
            AND stat_type = #{statType}
        </if>
        GROUP BY merchant_id, merchant_name
        ORDER BY success_amount DESC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 查询时段分析（小时统计）-->
    <select id="selectHourlyAnalysis" resultType="java.util.Map">
        SELECT 
            stat_hour,
            SUM(total_count) as total_count,
            SUM(success_count) as success_count,
            SUM(success_amount) as success_amount,
            ROUND(AVG(success_rate), 2) as avg_success_rate
        FROM t_payment_statistics 
        WHERE deleted = 0
        AND stat_type = 'HOURLY'
        <if test="statDate != null and statDate != ''">
            AND stat_date = #{statDate}
        </if>
        <if test="payType != null and payType != ''">
            AND pay_type = #{payType}
        </if>
        GROUP BY stat_hour
        ORDER BY stat_hour ASC
    </select>

    <!-- 查询趋势分析 -->
    <select id="selectTrendAnalysis" resultType="java.util.Map">
        SELECT 
            stat_date,
            SUM(total_count) as total_count,
            SUM(success_count) as success_count,
            SUM(success_amount) as success_amount,
            ROUND(SUM(success_count) * 100.0 / SUM(total_count), 2) as success_rate,
            LAG(SUM(total_count)) OVER (ORDER BY stat_date) as prev_total_count,
            LAG(SUM(success_amount)) OVER (ORDER BY stat_date) as prev_success_amount
        FROM t_payment_statistics 
        WHERE deleted = 0
        AND stat_type = 'DAILY'
        <if test="startDate != null and startDate != ''">
            AND stat_date >= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND stat_date &lt;= #{endDate}
        </if>
        GROUP BY stat_date
        ORDER BY stat_date ASC
    </select>

    <!-- 更新统计数据（支持增量更新）-->
    <update id="updateStatistics">
        UPDATE t_payment_statistics 
        SET total_count = total_count + #{totalCountDelta},
            success_count = success_count + #{successCountDelta},
            failed_count = failed_count + #{failedCountDelta},
            total_amount = total_amount + #{totalAmountDelta},
            success_amount = success_amount + #{successAmountDelta},
            success_rate = CASE 
                WHEN (total_count + #{totalCountDelta}) > 0 
                THEN ROUND((success_count + #{successCountDelta}) * 100.0 / (total_count + #{totalCountDelta}), 2)
                ELSE 0 
            END,
            avg_amount = CASE 
                WHEN (success_count + #{successCountDelta}) > 0 
                THEN ROUND((success_amount + #{successAmountDelta}) / (success_count + #{successCountDelta}), 2)
                ELSE 0 
            END,
            update_time = NOW(),
            version = version + 1
        WHERE id = #{id} AND version = #{version} AND deleted = 0
    </update>

    <!-- 批量清理过期统计数据 -->
    <update id="batchCleanupExpiredStats">
        UPDATE t_payment_statistics 
        SET deleted = 1,
            update_time = NOW()
        WHERE deleted = 0 
        AND stat_date &lt; DATE_SUB(CURDATE(), INTERVAL #{retentionDays} DAY)
        AND stat_type = #{statType}
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </update>

    <!-- 复杂条件查询统计数据 -->
    <select id="selectByMultipleConditions" resultMap="paymentStatisticsMap">
        SELECT * FROM t_payment_statistics 
        WHERE deleted = 0
        <if test="merchantId != null">
            AND merchant_id = #{merchantId}
        </if>
        <if test="merchantName != null and merchantName != ''">
            AND merchant_name LIKE CONCAT('%', #{merchantName}, '%')
        </if>
        <if test="payType != null and payType != ''">
            AND pay_type = #{payType}
        </if>
        <if test="payScene != null and payScene != ''">
            AND pay_scene = #{payScene}
        </if>
        <if test="statType != null and statType != ''">
            AND stat_type = #{statType}
        </if>
        <if test="startDate != null and startDate != ''">
            AND stat_date >= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND stat_date &lt;= #{endDate}
        </if>
        <if test="minSuccessRate != null">
            AND success_rate >= #{minSuccessRate}
        </if>
        <if test="minAmount != null">
            AND success_amount >= #{minAmount}
        </if>
        ORDER BY stat_date DESC, stat_hour DESC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

</mapper> 