<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gig.collide.favorite.infrastructure.mapper.FavoriteFolderMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.gig.collide.favorite.domain.entity.FavoriteFolder">
        <id column="folder_id" property="folderId" jdbcType="BIGINT"/>
        <result column="folder_name" property="folderName" jdbcType="VARCHAR"/>
        <result column="description" property="description" jdbcType="VARCHAR"/>
        <result column="folder_type" property="folderType" jdbcType="VARCHAR" 
                typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result column="user_id" property="userId" jdbcType="BIGINT"/>
        <result column="is_default" property="isDefault" jdbcType="BOOLEAN"/>
        <result column="cover_image" property="coverImage" jdbcType="VARCHAR"/>
        <result column="sort_order" property="sortOrder" jdbcType="INTEGER"/>
        <result column="item_count" property="itemCount" jdbcType="INTEGER"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
        <result column="is_deleted" property="isDeleted" jdbcType="TINYINT"/>
        <result column="version" property="version" jdbcType="INTEGER"/>
    </resultMap>

    <!-- 基础字段列表 -->
    <sql id="Base_Column_List">
        folder_id, folder_name, description, folder_type, user_id, is_default,
        cover_image, sort_order, item_count, create_time, update_time, is_deleted, version
    </sql>

    <!-- 查询用户收藏夹列表 -->
    <select id="selectUserFolders" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_favorite_folder
        WHERE user_id = #{userId}
        AND is_deleted = 0
        ORDER BY is_default DESC, sort_order ASC, create_time ASC
    </select>

    <!-- 查询用户默认收藏夹 -->
    <select id="selectDefaultFolder" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_favorite_folder
        WHERE user_id = #{userId}
        AND is_default = 1
        AND is_deleted = 0
        LIMIT 1
    </select>

    <!-- 查询用户指定类型的收藏夹 -->
    <select id="selectUserFoldersByType" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_favorite_folder
        WHERE user_id = #{userId}
        AND folder_type = #{folderType}
        AND is_deleted = 0
        ORDER BY sort_order ASC, create_time ASC
    </select>

    <!-- 根据ID查询收藏夹详情 -->
    <select id="selectByFolderId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_favorite_folder
        WHERE folder_id = #{folderId}
        AND is_deleted = 0
    </select>

    <!-- 检查收藏夹名称是否已存在 -->
    <select id="checkFolderNameExists" resultType="java.lang.Boolean">
        SELECT COUNT(1) > 0
        FROM t_favorite_folder
        WHERE user_id = #{userId}
        AND folder_name = #{folderName}
        AND is_deleted = 0
        <if test="excludeFolderId != null">
            AND folder_id != #{excludeFolderId}
        </if>
    </select>

    <!-- 统计用户收藏夹数量 -->
    <select id="countUserFolders" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM t_favorite_folder
        WHERE user_id = #{userId}
        AND is_deleted = 0
        <if test="excludeDefault != null and excludeDefault == true">
            AND is_default = 0
        </if>
    </select>

    <!-- 更新收藏夹收藏数量 -->
    <update id="updateFolderItemCount">
        UPDATE t_favorite_folder
        SET item_count = GREATEST(0, item_count + #{delta}),
            update_time = NOW()
        WHERE folder_id = #{folderId}
        AND is_deleted = 0
    </update>

    <!-- 批量更新收藏夹收藏数量 -->
    <update id="refreshFolderItemCounts">
        UPDATE t_favorite_folder f
        SET f.item_count = (
            SELECT COUNT(1)
            FROM t_favorite fav
            WHERE fav.folder_id = f.folder_id
            AND fav.status = 'NORMAL'
            AND fav.is_deleted = 0
        ),
        f.update_time = NOW()
        WHERE f.folder_id IN
        <foreach collection="folderIds" item="folderId" open="(" separator="," close=")">
            #{folderId}
        </foreach>
        AND f.is_deleted = 0
    </update>

    <!-- 重置收藏夹收藏数量 -->
    <update id="resetFolderItemCount">
        UPDATE t_favorite_folder
        SET item_count = 0,
            update_time = NOW()
        WHERE folder_id = #{folderId}
        AND is_deleted = 0
    </update>

    <!-- 删除用户收藏夹（物理删除，清理数据用） -->
    <delete id="deleteUserFolders">
        DELETE FROM t_favorite_folder
        WHERE user_id = #{userId}
        <if test="excludeDefault != null and excludeDefault == true">
            AND is_default = 0
        </if>
    </delete>

</mapper> 