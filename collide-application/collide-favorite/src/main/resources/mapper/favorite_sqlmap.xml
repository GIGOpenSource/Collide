<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gig.collide.favorite.infrastructure.mapper.FavoriteMapper">

    <!-- 分页查询用户收藏列表 -->
    <select id="selectUserFavoritePage" resultType="com.gig.collide.favorite.domain.entity.Favorite">
        SELECT 
            favorite_id,
            favorite_type,
            target_id,
            user_id,
            folder_id,
            status,
            remark,
            favorite_time,
            target_title,
            target_cover,
            target_author_id,
            target_author_name,
            target_author_avatar,
            target_publish_time,
            target_summary,
            create_time,
            update_time,
            version
        FROM collide_favorite
        WHERE user_id = #{userId}
        AND is_deleted = 0
        <if test="favoriteType != null">
            AND favorite_type = #{favoriteType}
        </if>
        <if test="folderId != null">
            AND folder_id = #{folderId}
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY favorite_time DESC
    </select>

    <!-- 检查是否已收藏 -->
    <select id="selectFavoriteId" resultType="java.lang.Long">
        SELECT favorite_id
        FROM collide_favorite
        WHERE user_id = #{userId}
        AND favorite_type = #{favoriteType}
        AND target_id = #{targetId}
        AND status = 'NORMAL'
        AND is_deleted = 0
        LIMIT 1
    </select>

    <!-- 统计用户收藏数量 -->
    <select id="countUserFavorites" resultType="java.lang.Long">
        SELECT COUNT(1)
        FROM collide_favorite
        WHERE user_id = #{userId}
        AND status = 'NORMAL'
        AND is_deleted = 0
        <if test="favoriteType != null">
            AND favorite_type = #{favoriteType}
        </if>
    </select>

    <!-- 统计目标被收藏数量 -->
    <select id="countTargetFavorites" resultType="java.lang.Long">
        SELECT COUNT(1)
        FROM collide_favorite
        WHERE favorite_type = #{favoriteType}
        AND target_id = #{targetId}
        AND status = 'NORMAL'
        AND is_deleted = 0
    </select>

    <!-- 批量更新收藏状态 -->
    <update id="batchUpdateStatus">
        UPDATE collide_favorite
        SET status = #{status},
            update_time = NOW()
        WHERE user_id = #{userId}
        AND target_id IN
        <foreach collection="targetIds" item="targetId" open="(" separator="," close=")">
            #{targetId}
        </foreach>
        AND is_deleted = 0
    </update>

</mapper> 