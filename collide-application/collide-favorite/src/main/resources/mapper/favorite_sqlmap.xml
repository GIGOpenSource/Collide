<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gig.collide.favorite.infrastructure.mapper.FavoriteMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.gig.collide.favorite.domain.entity.Favorite">
        <id column="favorite_id" property="favoriteId" jdbcType="BIGINT"/>
        <result column="favorite_type" property="favoriteType" jdbcType="VARCHAR" 
                typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result column="target_id" property="targetId" jdbcType="BIGINT"/>
        <result column="user_id" property="userId" jdbcType="BIGINT"/>
        <result column="folder_id" property="folderId" jdbcType="BIGINT"/>
        <result column="status" property="status" jdbcType="VARCHAR" 
                typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result column="remark" property="remark" jdbcType="VARCHAR"/>
        <result column="favorite_time" property="favoriteTime" jdbcType="TIMESTAMP"/>
        
        <!-- 冗余字段 -->
        <result column="target_title" property="targetTitle" jdbcType="VARCHAR"/>
        <result column="target_cover" property="targetCover" jdbcType="VARCHAR"/>
        <result column="target_author_id" property="targetAuthorId" jdbcType="BIGINT"/>
        <result column="target_author_name" property="targetAuthorName" jdbcType="VARCHAR"/>
        <result column="target_author_avatar" property="targetAuthorAvatar" jdbcType="VARCHAR"/>
        <result column="target_publish_time" property="targetPublishTime" jdbcType="TIMESTAMP"/>
        <result column="target_summary" property="targetSummary" jdbcType="LONGVARCHAR"/>
        
        <!-- 审计字段 -->
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
        <result column="is_deleted" property="isDeleted" jdbcType="TINYINT"/>
        <result column="version" property="version" jdbcType="INTEGER"/>
    </resultMap>

    <!-- 基础字段列表 -->
    <sql id="Base_Column_List">
        favorite_id, favorite_type, target_id, user_id, folder_id, status, remark, favorite_time,
        target_title, target_cover, target_author_id, target_author_name, target_author_avatar, 
        target_publish_time, target_summary, create_time, update_time, is_deleted, version
    </sql>

    <!-- 分页查询用户收藏列表 -->
    <select id="selectUserFavoritePage" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_favorite
        WHERE user_id = #{userId}
        AND is_deleted = 0
        <if test="favoriteType != null">
            AND favorite_type = #{favoriteType}
        </if>
        <if test="folderId != null">
            AND folder_id = #{folderId}
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY favorite_time DESC
    </select>

    <!-- 检查是否已收藏 -->
    <select id="selectFavoriteId" resultType="java.lang.Long">
        SELECT favorite_id
        FROM t_favorite
        WHERE user_id = #{userId}
        AND favorite_type = #{favoriteType}
        AND target_id = #{targetId}
        AND status = 'NORMAL'
        AND is_deleted = 0
        LIMIT 1
    </select>

    <!-- 根据收藏ID查询收藏记录 -->
    <select id="selectByFavoriteId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM t_favorite
        WHERE favorite_id = #{favoriteId}
        AND is_deleted = 0
    </select>

    <!-- 统计用户收藏数量 -->
    <select id="countUserFavorites" resultType="java.lang.Long">
        SELECT COUNT(1)
        FROM t_favorite
        WHERE user_id = #{userId}
        AND status = 'NORMAL'
        AND is_deleted = 0
        <if test="favoriteType != null">
            AND favorite_type = #{favoriteType}
        </if>
    </select>

    <!-- 统计目标被收藏数量 -->
    <select id="countTargetFavorites" resultType="java.lang.Long">
        SELECT COUNT(1)
        FROM t_favorite
        WHERE favorite_type = #{favoriteType}
        AND target_id = #{targetId}
        AND status = 'NORMAL'
        AND is_deleted = 0
    </select>

    <!-- 批量更新收藏状态 -->
    <update id="batchUpdateStatus">
        UPDATE t_favorite
        SET status = #{status},
            update_time = NOW()
        WHERE user_id = #{userId}
        AND target_id IN
        <foreach collection="targetIds" item="targetId" open="(" separator="," close=")">
            #{targetId}
        </foreach>
        AND is_deleted = 0
    </update>

    <!-- 查询用户收藏的目标ID列表 -->
    <select id="selectUserFavoriteTargetIds" resultType="java.lang.Long">
        SELECT DISTINCT target_id
        FROM t_favorite
        WHERE user_id = #{userId}
        AND favorite_type = #{favoriteType}
        AND status = 'NORMAL'
        AND is_deleted = 0
        <if test="targetIds != null and targetIds.size() > 0">
            AND target_id IN
            <foreach collection="targetIds" item="targetId" open="(" separator="," close=")">
                #{targetId}
            </foreach>
        </if>
    </select>

    <!-- 查询收藏夹中的收藏数量 -->
    <select id="countFolderFavorites" resultType="java.lang.Long">
        SELECT COUNT(1)
        FROM t_favorite
        WHERE folder_id = #{folderId}
        AND status = 'NORMAL'
        AND is_deleted = 0
    </select>

    <!-- 删除用户收藏记录（物理删除，清理数据用） -->
    <delete id="deleteUserFavorites">
        DELETE FROM t_favorite
        WHERE user_id = #{userId}
        <if test="favoriteType != null">
            AND favorite_type = #{favoriteType}
        </if>
    </delete>

</mapper> 