# Collide Gateway ç½‘å…³æ¨¡å—ç²¾ç®€æ€»ç»“

## ğŸ¯ ç²¾ç®€ç›®æ ‡
åŸºäºç®€æ´ç‰ˆç”¨æˆ·APIï¼Œé‡æ„ç½‘å…³çš„ç»Ÿä¸€é‰´æƒä½“ç³»ï¼Œå®ç°åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ï¼Œç®€åŒ–é‰´æƒé€»è¾‘ã€‚

## âœ… å·²å®Œæˆçš„ç²¾ç®€å·¥ä½œ

### 1. ğŸ”— æƒé™æ¥å£é‡æ„

**StpInterfaceImpl.java - ç®€æ´ç‰ˆæƒé™æ¥å£**:
- âœ… **åŸºäºæ–°ç”¨æˆ·ç»“æ„**: é€‚é…ç®€æ´ç‰ˆç”¨æˆ·APIçš„Sessionæ•°æ®ç»“æ„
- âœ… **è§’è‰²ç»§æ‰¿ä½“ç³»**: admin > blogger > vip > user çš„è§’è‰²ç»§æ‰¿
- âœ… **æƒé™æ˜ å°„é€»è¾‘**: åŸºäºè§’è‰²è‡ªåŠ¨åˆ†é…å¯¹åº”æƒé™
- âœ… **çŠ¶æ€æ£€æŸ¥**: åªæœ‰activeçŠ¶æ€ç”¨æˆ·æ‰èƒ½è·å¾—æƒé™

```java
// æƒé™åˆ†é…é€»è¾‘
switch (role) {
    case "admin":
        permissions.addAll(Arrays.asList("admin", "blogger", "vip", "user_manage", "content_manage"));
        break;
    case "blogger":
        permissions.addAll(Arrays.asList("blogger", "content_create", "content_manage"));
        break;
    case "vip":
        permissions.add("vip");
        break;
    case "user":
    default:
        // åªæœ‰åŸºç¡€æƒé™
        break;
}
```

### 2. ğŸ›¡ï¸ é‰´æƒé…ç½®é‡æ„

**SaTokenConfigure.java - ç»Ÿä¸€é‰´æƒé…ç½®**:
- âœ… **è·¯å¾„é€‚é…**: æ›´æ–°ä¸ºç®€æ´ç‰ˆAPIè·¯å¾„æ ¼å¼ `/api/v1/**`
- âœ… **è®¤è¯æµç¨‹**: é€‚é…æ–°çš„è®¤è¯æœåŠ¡æ¥å£è·¯å¾„
- âœ… **æƒé™åˆ†çº§**: å®ç°ç”¨æˆ·/VIP/åšä¸»/ç®¡ç†å‘˜å››çº§æƒé™ä½“ç³»
- âœ… **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„æƒé™é”™è¯¯æç¤ºå’Œå“åº”ç 

### 3. ğŸ“ æ–‡ä»¶ç»“æ„ä¼˜åŒ–

**åˆ é™¤çš„å†—ä½™ç»„ä»¶**:
- âŒ `BloggerPermissionConfig.java` - åšä¸»æƒé™é…ç½®ï¼ˆåˆå¹¶åˆ°ç»Ÿä¸€é…ç½®ï¼‰

**ä¿ç•™çš„æ ¸å¿ƒç»„ä»¶**:
```
collide-gateway/
â”œâ”€â”€ auth/
â”‚   â”œâ”€â”€ SaTokenConfigure.java (ç»Ÿä¸€é‰´æƒé…ç½®)
â”‚   â””â”€â”€ StpInterfaceImpl.java (æƒé™æ¥å£å®ç°)
â”œâ”€â”€ config/
â”‚   â””â”€â”€ GatewayConfig.java (ç½‘å…³åŸºç¡€é…ç½®)
â”œâ”€â”€ filter/
â”‚   â””â”€â”€ GlobalResponseFilter.java (å…¨å±€å“åº”è¿‡æ»¤å™¨)
â””â”€â”€ CollideGatewayApplication.java (å¯åŠ¨ç±»)
```

### 4. ğŸ”„ è®¤è¯æµç¨‹é›†æˆ

**è®¤è¯æ¨¡å—Sessionå­˜å‚¨**:
```java
// ç™»å½•æˆåŠŸåå­˜å‚¨ç”¨æˆ·ä¿¡æ¯åˆ°Session
StpUtil.getSession().set("userInfo", Map.of(
    "id", userInfo.getId(),
    "username", userInfo.getUsername(),
    "role", userInfo.getRole(),
    "status", userInfo.getStatus()
));
```

**ç½‘å…³æƒé™è·å–**:
```java
// ä»Sessionè·å–ç”¨æˆ·ä¿¡æ¯è¿›è¡Œæƒé™åˆ¤æ–­
Object userInfoObj = StpUtil.getSessionByLoginId(loginId).get("userInfo");
Map<String, Object> userInfo = (Map<String, Object>) userInfoObj;
String role = (String) userInfo.get("role");
String status = (String) userInfo.get("status");
```

## ğŸš€ æƒé™ä½“ç³»è®¾è®¡

### è§’è‰²å±‚çº§
```
admin (ç®¡ç†å‘˜)
  â”œâ”€â”€ æ‹¥æœ‰æ‰€æœ‰æƒé™
  â”œâ”€â”€ ç”¨æˆ·ç®¡ç†ã€å†…å®¹ç®¡ç†
  â””â”€â”€ ç»§æ‰¿: blogger + vip + user

blogger (åšä¸»)
  â”œâ”€â”€ å†…å®¹åˆ›å»ºå’Œç®¡ç†
  â”œâ”€â”€ å•†å“å‘å¸ƒå’Œç®¡ç†
  â””â”€â”€ ç»§æ‰¿: user

vip (VIPç”¨æˆ·)
  â”œâ”€â”€ VIPä¸“å±å†…å®¹è®¿é—®
  â””â”€â”€ ç»§æ‰¿: user

user (æ™®é€šç”¨æˆ·)
  â””â”€â”€ åŸºç¡€åŠŸèƒ½æƒé™
```

### æƒé™åˆ†é…
| è§’è‰² | æƒé™åˆ—è¡¨ |
|------|----------|
| **admin** | admin, blogger, vip, user_manage, content_manage, basic |
| **blogger** | blogger, content_create, content_manage, basic |
| **vip** | vip, basic |
| **user** | basic |

### APIæƒé™æ§åˆ¶

**å…¬å¼€è®¿é—®** (æ— éœ€ç™»å½•):
- âœ… è®¤è¯æ¥å£: `/api/v1/auth/login`, `/api/v1/auth/register`
- âœ… å†…å®¹æŸ¥çœ‹: `/api/v1/content/list`, `/api/v1/content/detail/**`
- âœ… æœç´¢åŠŸèƒ½: `/api/v1/search/**`, `/api/v1/content/search`
- âœ… æ ‡ç­¾åˆ†ç±»: `/api/v1/tag/**`, `/api/v1/category/**`

**ç™»å½•ç”¨æˆ·** (éœ€è¦ç™»å½•):
- âœ… ç”¨æˆ·ç®¡ç†: `/api/v1/users/**`
- âœ… ç¤¾äº¤åŠŸèƒ½: `/api/v1/social/**`, `/api/v1/follow/**`
- âœ… äº’åŠ¨åŠŸèƒ½: `/api/v1/like/**`, `/api/v1/favorite/**`, `/api/v1/comment/**`
- âœ… æ–‡ä»¶ä¸Šä¼ : `/api/v1/files/upload`

**åšä¸»æƒé™** (éœ€è¦bloggerè§’è‰²):
- âœ… å†…å®¹ç®¡ç†: `/api/v1/content/blogger/**`
- âœ… å•†å“ç®¡ç†: `/api/v1/goods/create`, `/api/v1/goods/update/**`

**VIPæƒé™** (éœ€è¦vipæƒé™):
- âœ… VIPå†…å®¹: `/api/v1/content/vip/**`

**ç®¡ç†å‘˜æƒé™** (éœ€è¦adminè§’è‰²):
- âœ… ç®¡ç†åå°: `/admin/**`

## ğŸ”§ æŠ€æœ¯å®ç°

### è·¯å¾„åŒ¹é…
```java
// åšä¸»åŠŸèƒ½æƒé™æ§åˆ¶
SaRouter.match("/api/v1/content/blogger/**").check(r -> {
    StpUtil.checkLogin();
    StpUtil.checkRoleOr("blogger", "admin");
});

// VIPåŠŸèƒ½æƒé™æ§åˆ¶  
SaRouter.match("/api/v1/content/vip/**").check(r -> {
    StpUtil.checkLogin();
    StpUtil.checkPermissionOr("vip", "admin");
});
```

### å¼‚å¸¸å¤„ç†
```java
// ç»Ÿä¸€çš„æƒé™å¼‚å¸¸å¤„ç†
case NotRoleException ex -> {
    String role = ex.getRole();
    if ("admin".equals(role)) {
        yield SaResult.error("éœ€è¦ç®¡ç†å‘˜æƒé™").setCode(403);
    } else if ("blogger".equals(role)) {
        yield SaResult.error("éœ€è¦åšä¸»è®¤è¯").setCode(403);
    }
    yield SaResult.error("æƒé™ä¸è¶³").setCode(403);
}
```

## ğŸ“ˆ ç²¾ç®€æ•ˆæœ

| ç»„ä»¶ | ç²¾ç®€å‰ | ç²¾ç®€å | ä¼˜åŒ–æ•ˆæœ |
|------|-------|-------|----------|
| **é…ç½®æ–‡ä»¶** | 2ä¸ªå¤æ‚é…ç½® | 1ä¸ªç»Ÿä¸€é…ç½® | **50%** å‡å°‘ |
| **æƒé™é€»è¾‘** | åˆ†æ•£åœ¨å¤šå¤„ | é›†ä¸­ç»Ÿä¸€ç®¡ç† | **ä¸€è‡´æ€§æå‡** |
| **APIè·¯å¾„** | æ—§ç‰ˆè·¯å¾„æ ¼å¼ | æ ‡å‡†RESTful | **è§„èŒƒåŒ–** |
| **è§’è‰²ä½“ç³»** | ç®€å•äºŒå…ƒæƒé™ | å››çº§ç»§æ‰¿ä½“ç³» | **çµæ´»æ€§æå‡** |

## ğŸ› ï¸ éƒ¨ç½²é…ç½®

### è·¯ç”±é…ç½®
- **ç½‘å…³ç«¯å£**: 9500
- **è®¤è¯æœåŠ¡**: 9502  
- **ç”¨æˆ·æœåŠ¡**: 9501
- **å…¶ä»–ä¸šåŠ¡æœåŠ¡**: 95xx

### Sa-Tokené…ç½®
```yaml
sa-token:
  token-name: Authorization
  timeout: 604800  # 7å¤©
  activity-timeout: -1
  is-concurrent: true
  is-share: true
  is-log: true
```

## ğŸ” å®‰å…¨ç‰¹æ€§

### ä¼šè¯ç®¡ç†
- âœ… **Tokenæœ‰æ•ˆæœŸ**: 7å¤©è‡ªåŠ¨è¿‡æœŸ
- âœ… **å¹¶å‘ç™»å½•**: æ”¯æŒå¤šè®¾å¤‡åŒæ—¶ç™»å½•
- âœ… **ä¼šè¯å…±äº«**: å¾®æœåŠ¡é—´å…±äº«ç™»å½•çŠ¶æ€

### æƒé™æ§åˆ¶
- âœ… **è§’è‰²ç»§æ‰¿**: é«˜çº§è§’è‰²è‡ªåŠ¨æ‹¥æœ‰ä½çº§æƒé™
- âœ… **çŠ¶æ€æ£€æŸ¥**: åªæœ‰activeç”¨æˆ·æ‰èƒ½é€šè¿‡é‰´æƒ
- âœ… **è·¯å¾„åŒ¹é…**: ç²¾ç¡®çš„APIè·¯å¾„æƒé™æ§åˆ¶

### å¼‚å¸¸å¤„ç†
- âœ… **ç»Ÿä¸€å“åº”**: æ ‡å‡†åŒ–çš„æƒé™é”™è¯¯æç¤º
- âœ… **è¯¦ç»†æ—¥å¿—**: å®Œæ•´çš„é‰´æƒæ“ä½œæ—¥å¿—è®°å½•
- âœ… **ä¼˜é›…é™çº§**: å¼‚å¸¸æƒ…å†µä¸‹çš„å®‰å…¨å¤„ç†

## ğŸ“‹ æµ‹è¯•è¦ç‚¹

1. **ç™»å½•æµç¨‹**: éªŒè¯ç™»å½•åSessionä¸­çš„ç”¨æˆ·ä¿¡æ¯å­˜å‚¨
2. **æƒé™ç»§æ‰¿**: éªŒè¯adminç”¨æˆ·æ‹¥æœ‰æ‰€æœ‰è§’è‰²æƒé™
3. **åšä¸»åŠŸèƒ½**: éªŒè¯bloggerè§’è‰²çš„å†…å®¹ç®¡ç†æƒé™
4. **VIPåŠŸèƒ½**: éªŒè¯vipæƒé™çš„ä¸“å±å†…å®¹è®¿é—®
5. **å…¬å¼€æ¥å£**: éªŒè¯æ— éœ€ç™»å½•çš„æ¥å£æ­£å¸¸è®¿é—®
6. **å¼‚å¸¸å¤„ç†**: éªŒè¯å„ç§æƒé™å¼‚å¸¸çš„æ­£ç¡®æç¤º

## ğŸš€ éƒ¨ç½²æ³¨æ„äº‹é¡¹

### æœåŠ¡ä¾èµ–
- ç¡®ä¿è®¤è¯æœåŠ¡2.0.0ç‰ˆæœ¬æ­£å¸¸è¿è¡Œ
- éªŒè¯ç”¨æˆ·æœåŠ¡2.0.0ç‰ˆæœ¬å·²éƒ¨ç½²
- æ£€æŸ¥Sa-Tokené…ç½®çš„Redisè¿æ¥

### é…ç½®æ£€æŸ¥
- æ›´æ–°å„æœåŠ¡çš„ç½‘å…³è·¯ç”±é…ç½®
- éªŒè¯Nacosä¸­çš„æœåŠ¡æ³¨å†Œå‘ç°
- ç¡®è®¤å„æœåŠ¡ç«¯å£é…ç½®æ­£ç¡®

---
**ç²¾ç®€å®Œæˆæ—¶é—´**: 2024-12-19  
**è´Ÿè´£äºº**: GIG Team  
**ç‰ˆæœ¬**: 2.0.0 ç®€æ´ç‰ˆ  
**çŠ¶æ€**: âœ… ç»Ÿä¸€é‰´æƒä½“ç³»å®Œæˆï¼ŒåŸºäºè§’è‰²çš„æƒé™æ§åˆ¶  
**å…¼å®¹æ€§**: ï¿½ï¿½ å‰ç«¯é›¶å½±å“ï¼Œåç«¯æƒé™ä½“ç³»å…¨é¢å‡çº§ 