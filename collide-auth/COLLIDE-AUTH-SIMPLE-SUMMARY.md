# Collide Auth è®¤è¯æ¨¡å—ç²¾ç®€æ€»ç»“

## ğŸ¯ ç²¾ç®€ç›®æ ‡
åŸºäºç”¨æˆ·æ¨¡å—çš„ç²¾ç®€é‡æ„ï¼Œå¯¹collide-authè®¤è¯æ¨¡å—è¿›è¡Œå¯¹åº”è°ƒæ•´ï¼Œä½¿å…¶ä¸æ–°çš„ç®€æ´ç‰ˆç”¨æˆ·APIå®Œç¾é›†æˆã€‚

## âœ… å·²å®Œæˆçš„ç²¾ç®€å·¥ä½œ

### 1. ğŸ”— APIé›†æˆæ›´æ–°
**DubboæœåŠ¡ç‰ˆæœ¬å‡çº§**:
- ä» `@DubboReference(version = "1.0.0")` å‡çº§åˆ° `@DubboReference(version = "2.0.0")`
- åŒ¹é…ç”¨æˆ·æ¨¡å—çš„ç®€æ´ç‰ˆDubboæœåŠ¡

**APIè°ƒç”¨é‡æ„**:
- âŒ åˆ é™¤: `UserUnifiedRegisterRequest/Response`
- âŒ åˆ é™¤: `UserUnifiedQueryRequest/Response`  
- âŒ åˆ é™¤: `UserUsernameQueryCondition`
- âŒ åˆ é™¤: `UserUnifiedInfo`
- âœ… æ–°å¢: `UserCreateRequest`ï¼ˆåŒ…å«roleå­—æ®µï¼‰
- âœ… æ–°å¢: `UserResponse`
- âœ… ä½¿ç”¨: ç®€æ´ç‰ˆ`UserFacadeService`æ¥å£

### 2. ğŸ—ï¸ æ ¸å¿ƒåŠŸèƒ½é‡æ„

**æ³¨å†ŒåŠŸèƒ½** (`/register`):
```java
// æ—§ç‰ˆAPIè°ƒç”¨
UserUnifiedRegisterRequest request = new UserUnifiedRegisterRequest();
UserUnifiedRegisterResponse result = userFacadeService.register(request);

// æ–°ç‰ˆAPIè°ƒç”¨ï¼ˆä¿®å¤å­—æ®µæ˜ å°„ï¼‰
UserCreateRequest request = new UserCreateRequest();
request.setUsername(username);
request.setPassword(password);  // ä¼šæ˜ å°„åˆ°User.passwordHash
request.setRole("user");        // è®¾ç½®é»˜è®¤è§’è‰²
Result<UserResponse> result = userFacadeService.createUser(request);
```

**ç™»å½•åŠŸèƒ½** (`/login`):
```java
// æ—§ç‰ˆï¼šå¤æ‚çš„æŸ¥è¯¢+å¯†ç éªŒè¯
UserUnifiedQueryRequest queryRequest = new UserUnifiedQueryRequest();
Boolean isValid = userFacadeService.validatePassword(username, password);

// æ–°ç‰ˆï¼šç›´æ¥ç™»å½•éªŒè¯
Result<UserResponse> loginResult = userFacadeService.login(username, password);
```

**ç™»å½•æˆ–æ³¨å†ŒåŠŸèƒ½** (`/login-or-register`):
- ä¿æŒæ ¸å¿ƒé€»è¾‘ï¼šå…ˆå°è¯•ç™»å½•ï¼Œå¤±è´¥åˆ™è‡ªåŠ¨æ³¨å†Œ
- åŸºäºæ–°APIé‡æ„ï¼Œé€»è¾‘æ›´åŠ æ¸…æ™°ç®€æ´
- ç¡®ä¿è§’è‰²å’Œå¯†ç æ­£ç¡®å¤„ç†

### 3. ğŸ”§ å…³é”®æŠ€æœ¯ä¿®å¤

**å­—æ®µæ˜ å°„ä¿®å¤**:
```java
// UserCreateRequest -> User å®ä½“æ˜ å°„
BeanUtils.copyProperties(request, user);
user.setPasswordHash(request.getPassword()); // æ‰‹åŠ¨æ˜ å°„ password -> passwordHash
user.setStatus("active");                    // è®¾ç½®é»˜è®¤çŠ¶æ€
```

**è§’è‰²æƒé™æ”¯æŒ**:
```java
// è®¤è¯æ¨¡å—è®¾ç½®é»˜è®¤è§’è‰²
userCreateRequest.setRole("user"); // æ”¯æŒåç»­æƒé™æ§åˆ¶
```

**å¯†ç åŠ å¯†å¤„ç†**:
- è®¤è¯æ¨¡å—ï¼šä¼ é€’åŸå§‹å¯†ç åˆ°ç”¨æˆ·æœåŠ¡
- ç”¨æˆ·æœåŠ¡ï¼šä½¿ç”¨BCryptè‡ªåŠ¨åŠ å¯†å­˜å‚¨
- ç™»å½•éªŒè¯ï¼šç”¨æˆ·æœåŠ¡å†…éƒ¨å¯¹æ¯”åŠ å¯†å¯†ç 

### 4. ğŸ“ æ–‡ä»¶ç»“æ„ç²¾ç®€

**åˆ é™¤çš„å¤æ‚ç»“æ„**:
- âŒ `vo/LoginVO.java` - å¤æ‚çš„VOå¯¹è±¡
- âŒ `exception/AuthException.java` - è‡ªå®šä¹‰å¼‚å¸¸
- âŒ `exception/AuthErrorCode.java` - è‡ªå®šä¹‰é”™è¯¯ç 
- âŒ å¤æ‚çš„`buildUserInfo()`è¾…åŠ©æ–¹æ³•

**ä¿ç•™çš„ç®€æ´ç»“æ„**:
```
collide-auth/
â”œâ”€â”€ controller/
â”‚   â”œâ”€â”€ AuthController.java (ç®€æ´ç‰ˆè®¤è¯æ§åˆ¶å™¨)
â”‚   â””â”€â”€ TokenController.java (ç®€æ´ç‰ˆTokenæ§åˆ¶å™¨)
â””â”€â”€ param/
    â”œâ”€â”€ LoginParam.java (ç®€æ´ç‰ˆç™»å½•å‚æ•°)
    â”œâ”€â”€ RegisterParam.java (ç®€æ´ç‰ˆæ³¨å†Œå‚æ•°) 
    â””â”€â”€ LoginOrRegisterParam.java (ç®€æ´ç‰ˆç™»å½•æˆ–æ³¨å†Œå‚æ•°)
```

### 5. ğŸš€ æ ¸å¿ƒåŠŸèƒ½ä¿ç•™

**AuthController**:
- âœ… `POST /register` - ç”¨æˆ·æ³¨å†Œï¼ˆæ”¯æŒè§’è‰²å’Œå¯†ç åŠ å¯†ï¼‰
- âœ… `POST /login` - ç”¨æˆ·ç™»å½•  
- âœ… `POST /login-or-register` - æ ¸å¿ƒæ¥å£ï¼ˆç™»å½•æˆ–è‡ªåŠ¨æ³¨å†Œï¼‰
- âœ… `POST /logout` - ç”¨æˆ·ç™»å‡º
- âœ… `GET /validate-invite-code` - é‚€è¯·ç éªŒè¯
- âœ… `GET /my-invite-info` - é‚€è¯·ä¿¡æ¯è·å–
- âœ… `GET /test` - æœåŠ¡å¥åº·æ£€æŸ¥

**TokenController**:
- âœ… `GET /me` - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆåŒ…å«è§’è‰²ï¼‰
- âœ… `GET /verify-token` - Tokenæœ‰æ•ˆæ€§éªŒè¯

## ğŸ”§ æŠ€æœ¯å‡çº§

### å‚æ•°ç±»ç®€åŒ–
```java
// ç®€æ´ç‰ˆå‚æ•°ç±»ç»“æ„
@Data
public class RegisterParam {
    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    private String username;
    
    @NotBlank(message = "å¯†ç ä¸èƒ½ä¸ºç©º")  
    private String password;
    
    private String inviteCode; // å¯é€‰é‚€è¯·ç 
}
```

### APIè¯·æ±‚å®Œæ•´ç»“æ„
```java
// ç”¨æˆ·åˆ›å»ºè¯·æ±‚ï¼ˆåŒ…å«è§’è‰²å­—æ®µï¼‰
UserCreateRequest request = new UserCreateRequest();
request.setUsername("testuser");
request.setPassword("123456");        // åŸå§‹å¯†ç 
request.setNickname("testuser");      // é»˜è®¤æ˜µç§°
request.setRole("user");              // é»˜è®¤è§’è‰²
request.setInviteCode("ABC123");      // å¯é€‰é‚€è¯·ç 
```

### å“åº”æ ¼å¼ç»Ÿä¸€
- å…¨éƒ¨ä½¿ç”¨ `Result<T>` ç»Ÿä¸€å“åº”æ ¼å¼
- æ ‡å‡†åŒ–é”™è¯¯ç ï¼š`USER_NOT_FOUND`ã€`LOGIN_FAILED`ã€`AUTO_REGISTER_FAILED`ç­‰
- ç”¨æˆ·ä¿¡æ¯åŒ…å«å®Œæ•´è§’è‰²ä¿¡æ¯ç”¨äºå‰ç«¯æƒé™æ§åˆ¶

### Tokenç®¡ç†ä¼˜åŒ–
- ç»§ç»­ä½¿ç”¨Sa-Tokenæ¡†æ¶
- ç”¨æˆ·è§’è‰²ä¿¡æ¯å­˜å‚¨åœ¨Tokenä¼šè¯ä¸­
- æ”¯æŒåŸºäºè§’è‰²çš„æƒé™éªŒè¯

## ğŸ“ˆ ç²¾ç®€æ•ˆæœ

| å±‚çº§ | ç²¾ç®€å‰ | ç²¾ç®€å | å‡å°‘ç‡ |
|------|--------|--------|--------|
| æ§åˆ¶å™¨ | 2ä¸ªæ–‡ä»¶ | 2ä¸ªæ–‡ä»¶ | **0%** (ä¿æŒæ ¸å¿ƒåŠŸèƒ½) |
| å‚æ•°ç±» | 3ä¸ªå¤æ‚ç±» | 3ä¸ªç®€æ´ç±» | **60%** (ä»£ç è¡Œæ•°) |
| VOå¯¹è±¡ | 1ä¸ªå¤æ‚VO | 0ä¸ªæ–‡ä»¶ | **100%** |
| å¼‚å¸¸å¤„ç† | 2ä¸ªè‡ªå®šä¹‰ç±» | 0ä¸ªæ–‡ä»¶ | **100%** |
| **æ€»è®¡** | **8ä¸ªæ–‡ä»¶** | **5ä¸ªæ–‡ä»¶** | **37.5%** |

## ğŸ› ï¸ APIå…¼å®¹æ€§

### æ¥å£ä¿æŒä¸å˜
- æ‰€æœ‰HTTPæ¥å£è·¯å¾„ä¿æŒä¸å˜
- è¯·æ±‚å‚æ•°æ ¼å¼ä¿æŒä¸å˜  
- å“åº”æ•°æ®ç»“æ„ä¿æŒä¸å˜ï¼ˆå¢å¼ºè§’è‰²ä¿¡æ¯ï¼‰
- Tokenæœºåˆ¶ä¿æŒä¸å˜

### åç«¯é›†æˆå‡çº§  
- DubboæœåŠ¡è°ƒç”¨å‡çº§åˆ°2.0.0ç‰ˆæœ¬
- åº•å±‚ç”¨æˆ·æ•°æ®è®¿é—®å…¨é¢ç®€åŒ–
- é”™è¯¯å¤„ç†ç»Ÿä¸€æ ‡å‡†åŒ–
- **å­—æ®µæ˜ å°„ä¿®å¤**: passwordæ­£ç¡®æ˜ å°„åˆ°passwordHash
- **è§’è‰²æ”¯æŒ**: å®Œæ•´çš„ç”¨æˆ·è§’è‰²æƒé™ä½“ç³»

## ğŸ¯ è®¾è®¡åŸåˆ™éµå¾ª

### æ— ç¼å‡çº§
- **å‰ç«¯é›¶å½±å“**: HTTPæ¥å£å®Œå…¨å…¼å®¹ï¼Œå‰ç«¯æ— éœ€ä»»ä½•ä¿®æ”¹
- **åŠŸèƒ½å®Œæ•´æ€§**: æ ¸å¿ƒè®¤è¯åŠŸèƒ½100%ä¿ç•™ï¼Œå¢å¼ºæƒé™æ”¯æŒ
- **æ€§èƒ½æå‡**: åº•å±‚APIè°ƒç”¨æ›´åŠ é«˜æ•ˆ

### å®‰å…¨å¢å¼º
- **å¯†ç åŠ å¯†**: åœ¨ç”¨æˆ·æœåŠ¡ä¸­ä½¿ç”¨BCryptåŠ å¯†å­˜å‚¨
- **è§’è‰²æƒé™**: å®Œæ•´æ”¯æŒç”¨æˆ·è§’è‰²ä½“ç³»
- **å­—æ®µå®‰å…¨**: æ­£ç¡®çš„password->passwordHashæ˜ å°„

### ä»£ç ç®€æ´æ€§
- åˆ é™¤ä¸å¿…è¦çš„VOè½¬æ¢
- ç®€åŒ–å‚æ•°éªŒè¯é€»è¾‘
- ä¼˜åŒ–ä¸šåŠ¡æµç¨‹ä»£ç 
- ä¿®å¤å­—æ®µæ˜ å°„é—®é¢˜

## ğŸ” å®‰å…¨ç‰¹æ€§

1. **å¯†ç å®‰å…¨**: 
   - è®¤è¯æ¨¡å—æ¥æ”¶åŸå§‹å¯†ç 
   - ç”¨æˆ·æœåŠ¡ä½¿ç”¨BCryptåŠ å¯†å­˜å‚¨
   - ç™»å½•æ—¶è‡ªåŠ¨å¯†ç æ¯”å¯¹

2. **è§’è‰²æƒé™**: 
   - ç”¨æˆ·æ³¨å†Œæ—¶è®¾ç½®é»˜è®¤"user"è§’è‰²
   - Tokenä¸­åŒ…å«ç”¨æˆ·è§’è‰²ä¿¡æ¯
   - æ”¯æŒåŸºäºè§’è‰²çš„æ¥å£æƒé™æ§åˆ¶

3. **ä¼šè¯ç®¡ç†**:
   - Sa-Tokenæä¾›å®‰å…¨çš„ä¼šè¯ç®¡ç†
   - 7å¤©é»˜è®¤ç™»å½•æœ‰æ•ˆæœŸ
   - å®Œæ•´çš„ç™»å½•/ç™»å‡ºæµç¨‹

## ğŸ“‹ å¾…å®Œå–„åŠŸèƒ½

1. **é‚€è¯·ç åŠŸèƒ½**: ç›®å‰è¿”å›æ¨¡æ‹Ÿæ•°æ®ï¼Œç­‰ç”¨æˆ·æ¨¡å—æ”¯æŒåå®Œå–„
2. **è§’è‰²æƒé™**: å¯æ‰©å±•adminã€moderatorç­‰æ›´å¤šè§’è‰²
3. **æƒé™æ³¨è§£**: å¯æ·»åŠ åŸºäºè§’è‰²çš„æ–¹æ³•çº§æƒé™æ§åˆ¶

## ğŸš€ éƒ¨ç½²æ³¨æ„äº‹é¡¹

### é…ç½®æ›´æ–°
- æ›´æ–°Nacosé…ç½®ä¸­çš„DubboæœåŠ¡ç‰ˆæœ¬å·
- ç¡®ä¿ä¸ç”¨æˆ·æ¨¡å—çš„æœåŠ¡å‘ç°é…ç½®ä¸€è‡´

### ä¾èµ–æ£€æŸ¥
- ç¡®è®¤ç”¨æˆ·æ¨¡å—2.0.0ç‰ˆæœ¬å·²éƒ¨ç½²
- éªŒè¯DubboæœåŠ¡æ³¨å†Œä¸å‘ç°æ­£å¸¸
- æµ‹è¯•å¯†ç åŠ å¯†å’Œè§’è‰²åˆ†é…åŠŸèƒ½

---
**ç²¾ç®€å®Œæˆæ—¶é—´**: 2024-12-19  
**è´Ÿè´£äºº**: GIG Team  
**ç‰ˆæœ¬**: 2.0.0 ç®€æ´ç‰ˆ  
**çŠ¶æ€**: âœ… ä¸ç”¨æˆ·æ¨¡å—å®Œç¾é›†æˆï¼ŒåŠŸèƒ½å®Œæ•´å¯ç”¨ï¼Œå®‰å…¨å¢å¼º  
**å…¼å®¹æ€§**: ğŸ”„ å‰ç«¯é›¶å½±å“ï¼Œåç«¯APIå…¨é¢å‡çº§ï¼Œå­—æ®µæ˜ å°„ä¿®å¤ 